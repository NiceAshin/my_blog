<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Project Reactor | AshinBlog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="黑夜中前行，仍照亮前路!">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.08f94e03.css" as="style"><link rel="preload" href="/assets/js/app.8218fb5d.js" as="script"><link rel="preload" href="/assets/js/3.a30b6709.js" as="script"><link rel="preload" href="/assets/js/1.3bd31195.js" as="script"><link rel="preload" href="/assets/js/103.740971e5.js" as="script"><link rel="prefetch" href="/assets/js/10.1c699308.js"><link rel="prefetch" href="/assets/js/100.aa95b17d.js"><link rel="prefetch" href="/assets/js/101.67ffef33.js"><link rel="prefetch" href="/assets/js/102.d1452359.js"><link rel="prefetch" href="/assets/js/104.352bcdd6.js"><link rel="prefetch" href="/assets/js/105.8ef6c086.js"><link rel="prefetch" href="/assets/js/106.4f818e1a.js"><link rel="prefetch" href="/assets/js/107.559970d2.js"><link rel="prefetch" href="/assets/js/108.ab661542.js"><link rel="prefetch" href="/assets/js/109.39ff50ea.js"><link rel="prefetch" href="/assets/js/11.c6035b01.js"><link rel="prefetch" href="/assets/js/110.1c6872dd.js"><link rel="prefetch" href="/assets/js/111.5318b366.js"><link rel="prefetch" href="/assets/js/112.cb0cc71d.js"><link rel="prefetch" href="/assets/js/113.4bc6dd2c.js"><link rel="prefetch" href="/assets/js/114.29eb323a.js"><link rel="prefetch" href="/assets/js/115.ee1e0532.js"><link rel="prefetch" href="/assets/js/116.175f92bc.js"><link rel="prefetch" href="/assets/js/117.ae5b6f33.js"><link rel="prefetch" href="/assets/js/118.7df9933d.js"><link rel="prefetch" href="/assets/js/119.07ea429a.js"><link rel="prefetch" href="/assets/js/12.840c8cf2.js"><link rel="prefetch" href="/assets/js/120.f8e13f41.js"><link rel="prefetch" href="/assets/js/121.5a170feb.js"><link rel="prefetch" href="/assets/js/122.974d5d86.js"><link rel="prefetch" href="/assets/js/123.11bbdd7c.js"><link rel="prefetch" href="/assets/js/124.eeed61d1.js"><link rel="prefetch" href="/assets/js/125.4ae9b36f.js"><link rel="prefetch" href="/assets/js/126.5806e542.js"><link rel="prefetch" href="/assets/js/127.8cf7dc5c.js"><link rel="prefetch" href="/assets/js/128.3d9a6c65.js"><link rel="prefetch" href="/assets/js/129.68e55c2f.js"><link rel="prefetch" href="/assets/js/13.a9a26afa.js"><link rel="prefetch" href="/assets/js/130.103caf73.js"><link rel="prefetch" href="/assets/js/131.d507d140.js"><link rel="prefetch" href="/assets/js/132.319875d9.js"><link rel="prefetch" href="/assets/js/133.69881e20.js"><link rel="prefetch" href="/assets/js/134.afcbb232.js"><link rel="prefetch" href="/assets/js/135.961d05d7.js"><link rel="prefetch" href="/assets/js/136.90693a14.js"><link rel="prefetch" href="/assets/js/137.df766ef9.js"><link rel="prefetch" href="/assets/js/138.06d49cd3.js"><link rel="prefetch" href="/assets/js/139.c1bee8d3.js"><link rel="prefetch" href="/assets/js/14.84997f9f.js"><link rel="prefetch" href="/assets/js/140.307f1090.js"><link rel="prefetch" href="/assets/js/141.41e8e3e1.js"><link rel="prefetch" href="/assets/js/142.8d44d96a.js"><link rel="prefetch" href="/assets/js/15.2bbd8ff3.js"><link rel="prefetch" href="/assets/js/16.8ad8799a.js"><link rel="prefetch" href="/assets/js/17.72858277.js"><link rel="prefetch" href="/assets/js/18.0a863d5b.js"><link rel="prefetch" href="/assets/js/19.fb087051.js"><link rel="prefetch" href="/assets/js/20.b9bd7960.js"><link rel="prefetch" href="/assets/js/21.1c57980d.js"><link rel="prefetch" href="/assets/js/22.fd6935f6.js"><link rel="prefetch" href="/assets/js/23.3a6272c2.js"><link rel="prefetch" href="/assets/js/24.170e0a41.js"><link rel="prefetch" href="/assets/js/25.ddff5762.js"><link rel="prefetch" href="/assets/js/26.1530486f.js"><link rel="prefetch" href="/assets/js/27.362c51b6.js"><link rel="prefetch" href="/assets/js/28.dd12b3e6.js"><link rel="prefetch" href="/assets/js/29.6d6252bb.js"><link rel="prefetch" href="/assets/js/30.831dfa52.js"><link rel="prefetch" href="/assets/js/31.b24226b2.js"><link rel="prefetch" href="/assets/js/32.3ce04dec.js"><link rel="prefetch" href="/assets/js/33.b09392ff.js"><link rel="prefetch" href="/assets/js/34.12dbafa0.js"><link rel="prefetch" href="/assets/js/35.20b5f707.js"><link rel="prefetch" href="/assets/js/36.486b7790.js"><link rel="prefetch" href="/assets/js/37.c445058f.js"><link rel="prefetch" href="/assets/js/38.05c45e9d.js"><link rel="prefetch" href="/assets/js/39.f7e645e8.js"><link rel="prefetch" href="/assets/js/4.3808e766.js"><link rel="prefetch" href="/assets/js/40.071fbc1e.js"><link rel="prefetch" href="/assets/js/41.874656f9.js"><link rel="prefetch" href="/assets/js/42.ab33fbbd.js"><link rel="prefetch" href="/assets/js/43.8afd89bd.js"><link rel="prefetch" href="/assets/js/44.b686da45.js"><link rel="prefetch" href="/assets/js/45.0781b8c9.js"><link rel="prefetch" href="/assets/js/46.f3d4f915.js"><link rel="prefetch" href="/assets/js/47.a08012de.js"><link rel="prefetch" href="/assets/js/48.6001077c.js"><link rel="prefetch" href="/assets/js/49.a99abda0.js"><link rel="prefetch" href="/assets/js/5.b659ac8f.js"><link rel="prefetch" href="/assets/js/50.0cb24f37.js"><link rel="prefetch" href="/assets/js/51.659ef805.js"><link rel="prefetch" href="/assets/js/52.8a6ff40e.js"><link rel="prefetch" href="/assets/js/53.3d768194.js"><link rel="prefetch" href="/assets/js/54.bf868281.js"><link rel="prefetch" href="/assets/js/55.0050143c.js"><link rel="prefetch" href="/assets/js/56.4b8a0053.js"><link rel="prefetch" href="/assets/js/57.eb8c090c.js"><link rel="prefetch" href="/assets/js/58.1b773a2d.js"><link rel="prefetch" href="/assets/js/59.91fd2a15.js"><link rel="prefetch" href="/assets/js/6.82e5b679.js"><link rel="prefetch" href="/assets/js/60.832f0ed0.js"><link rel="prefetch" href="/assets/js/61.36c57dbf.js"><link rel="prefetch" href="/assets/js/62.cf4c75eb.js"><link rel="prefetch" href="/assets/js/63.b2704fdf.js"><link rel="prefetch" href="/assets/js/64.b868f24c.js"><link rel="prefetch" href="/assets/js/65.234595bd.js"><link rel="prefetch" href="/assets/js/66.064facee.js"><link rel="prefetch" href="/assets/js/67.ca45df07.js"><link rel="prefetch" href="/assets/js/68.6ca03191.js"><link rel="prefetch" href="/assets/js/69.a53a5fee.js"><link rel="prefetch" href="/assets/js/7.8cc55f33.js"><link rel="prefetch" href="/assets/js/70.2c472343.js"><link rel="prefetch" href="/assets/js/71.3a0a5802.js"><link rel="prefetch" href="/assets/js/72.6d8e2045.js"><link rel="prefetch" href="/assets/js/73.cc4a590c.js"><link rel="prefetch" href="/assets/js/74.951efe84.js"><link rel="prefetch" href="/assets/js/75.a7f22b7d.js"><link rel="prefetch" href="/assets/js/76.27cf86a8.js"><link rel="prefetch" href="/assets/js/77.71f55b84.js"><link rel="prefetch" href="/assets/js/78.151ec9e5.js"><link rel="prefetch" href="/assets/js/79.44946107.js"><link rel="prefetch" href="/assets/js/8.4b6e007f.js"><link rel="prefetch" href="/assets/js/80.8777d920.js"><link rel="prefetch" href="/assets/js/81.abe5e44b.js"><link rel="prefetch" href="/assets/js/82.3b102110.js"><link rel="prefetch" href="/assets/js/83.f6ae12b6.js"><link rel="prefetch" href="/assets/js/84.166f980d.js"><link rel="prefetch" href="/assets/js/85.3403cbd5.js"><link rel="prefetch" href="/assets/js/86.59898fab.js"><link rel="prefetch" href="/assets/js/87.ba9a9d37.js"><link rel="prefetch" href="/assets/js/88.c325c789.js"><link rel="prefetch" href="/assets/js/89.4220f2f6.js"><link rel="prefetch" href="/assets/js/9.befca5eb.js"><link rel="prefetch" href="/assets/js/90.9dc65834.js"><link rel="prefetch" href="/assets/js/91.f3889d76.js"><link rel="prefetch" href="/assets/js/92.2b193afd.js"><link rel="prefetch" href="/assets/js/93.7f7cf159.js"><link rel="prefetch" href="/assets/js/94.04bbafd4.js"><link rel="prefetch" href="/assets/js/95.5128eabe.js"><link rel="prefetch" href="/assets/js/96.ec4ca01a.js"><link rel="prefetch" href="/assets/js/97.a0d1bdf0.js"><link rel="prefetch" href="/assets/js/98.62a26c8a.js"><link rel="prefetch" href="/assets/js/99.513ff1d6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.08f94e03.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>AshinBlog</h3> <p class="description" data-v-59e6cb88>黑夜中前行，仍照亮前路!</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>AshinZhang</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2026
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="AshinBlog" class="logo"> <span class="site-name">AshinBlog</span></a> <div class="links"><!----> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      架构设计
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ddd/" class="nav-link"><i class="undefined"></i>
  领域驱动设计
</a></li><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link"><i class="undefined"></i>
  微服务实践
</a></li><li class="dropdown-item"><!----> <a href="/design/" class="nav-link"><i class="undefined"></i>
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      编程语言
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active"><i class="undefined"></i>
  Java 栈
</a></li><li class="dropdown-item"><!----> <a href="/go/" class="nav-link"><i class="undefined"></i>
  Go 语言
</a></li><li class="dropdown-item"><!----> <a href="/yii2/" class="nav-link"><i class="undefined"></i>
  PHP(Yii2)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      基础设施
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link"><i class="undefined"></i>
  云原生
</a></li><li class="dropdown-item"><!----> <a href="/ground/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      AI 实践
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/" class="nav-link"><i class="undefined"></i>
  AI 探索
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程实践
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/#问题排查与经验" class="nav-link"><i class="undefined"></i>
  问题排查
</a></li><li class="dropdown-item"><!----> <a href="/more/#项目与配置实战" class="nav-link"><i class="undefined"></i>
  配置实战
</a></li><li class="dropdown-item"><!----> <a href="/more/#接口文档专区" class="nav-link"><i class="undefined"></i>
  接口文档
</a></li></ul></div></div> <a href="https://github.com/NiceAshin/my_blog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    AshinZhang
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>128</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>42</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      架构设计
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ddd/" class="nav-link"><i class="undefined"></i>
  领域驱动设计
</a></li><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link"><i class="undefined"></i>
  微服务实践
</a></li><li class="dropdown-item"><!----> <a href="/design/" class="nav-link"><i class="undefined"></i>
  设计模式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      编程语言
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active"><i class="undefined"></i>
  Java 栈
</a></li><li class="dropdown-item"><!----> <a href="/go/" class="nav-link"><i class="undefined"></i>
  Go 语言
</a></li><li class="dropdown-item"><!----> <a href="/yii2/" class="nav-link"><i class="undefined"></i>
  PHP(Yii2)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      基础设施
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link"><i class="undefined"></i>
  云原生
</a></li><li class="dropdown-item"><!----> <a href="/ground/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      AI 实践
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/" class="nav-link"><i class="undefined"></i>
  AI 探索
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程实践
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/#问题排查与经验" class="nav-link"><i class="undefined"></i>
  问题排查
</a></li><li class="dropdown-item"><!----> <a href="/more/#项目与配置实战" class="nav-link"><i class="undefined"></i>
  配置实战
</a></li><li class="dropdown-item"><!----> <a href="/more/#接口文档专区" class="nav-link"><i class="undefined"></i>
  接口文档
</a></li></ul></div></div> <a href="https://github.com/NiceAshin/my_blog" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>AshinZhang</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2026
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Project Reactor</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>AshinZhang</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>5/19/2024</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="project-reactor"><a href="#project-reactor" class="header-anchor">#</a> Project Reactor</h1> <blockquote><p>预计阅读时间：65 分钟</p></blockquote> <p>Reactor库由Spring推出, 并且Spring5的响应性也是基于Reactor实现. 在前两篇文章中我们已经知道, 回压是响应式流
中必不可少的一个属性, Reactor库实现了响应式流规范, 所以回压是Reactor本身的核心主题.</p> <p>Reactor支持所有常见的回压传播模式:</p> <ul><li>仅推送: 当订阅者通过subscription.request(Long.MAX_VALUE)请求无限数量的元素时.</li> <li>仅拉取: 当订阅者通过subscription.request(1)仅在收到前一个元素后请求下一个元素时.</li> <li>推拉混合: 当订阅者有实时控制需求, 且发布者可以适应消费者所提出的数据消费速度时.</li></ul> <h2 id="flux与mono"><a href="#flux与mono" class="header-anchor">#</a> Flux与Mono</h2> <p>我们已经知道响应式流规范定义的四个接口中<code>Publisher&lt;T&gt;</code>作为发布者的角色. Reactor提供了<code>Publisher&lt;T&gt;</code>接口的两种实现即<code>Flux&lt;T&gt;</code>和<code>Mono&lt;T&gt;</code>.</p> <p>Flux定义了一个普通的响应式流, 它可以产生0个, 1个 ,多个元素或者无限个元素.</p> <p>Mono定义一个最多可产生一个元素的流.</p> <p>Flux与Mono之间可以相互转换, 如使用<code>mono.repeat()</code>返回Flux, 使用<code>flux.collectList()</code>返回Mono. 同时它还可以优化一些不改变语义的转换. 如<code>Mono.from(Flux.from(mono))</code>返回原始的mono实例.</p> <h2 id="创建与订阅"><a href="#创建与订阅" class="header-anchor">#</a> 创建与订阅</h2> <h3 id="立即创建流"><a href="#立即创建流" class="header-anchor">#</a> 立即创建流</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_factoryMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;小&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;花&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;哥&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> just <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> array<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> array<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fromArray <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fromIterable <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 生成数字流  从2021开始, 生成5个   2021,2022,2023,2024,2025</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> range <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> fromOptional <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">justOrEmpty</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> fromRunnable <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ReactorTest.test_factoryMethod&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fromSupplier <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromSupplier</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">&quot;小花哥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 异步的发出Http请求</span>
        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fromCallable <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromCallable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">httpRequest</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">// 同步阻塞的http请求</span>
        <span class="token keyword">return</span> <span class="token string">&quot;HTTP Response&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_emptyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment">// 只发布complete信号的流</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> emptyFLux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 只传error信号的流</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> errorFlux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 不包含任何消息通知的流, 没有complete信号也没有error信号</span>
        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> neverFlux <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">never</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="延迟创建流"><a href="#延迟创建流" class="header-anchor">#</a> 延迟创建流</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_defer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mono <span class="token operator">=</span> <span class="token function">deferMono</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">deferMono</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        <span class="token comment">// Mono的实际创建时间延迟到每次发生订阅之后.</span>
        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> flag<span class="token operator">?</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;flag == true&quot;</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot; flag == false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="周期生成无限流"><a href="#周期生成无限流" class="header-anchor">#</a> 周期生成无限流</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_interval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token class-name">Disposable</span> disposable <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>e <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Received data ---&gt; &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 与rxjava一样   事件的发布与消费是在单独的守护线程中</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        disposable<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="生成流"><a href="#生成流" class="header-anchor">#</a> 生成流</h3> <p>这是一种同步的逐个产生值的方法.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>
                <span class="token comment">// 初始化一个状态变量</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token comment">// 改变状态</span>
                <span class="token punctuation">(</span>state<span class="token punctuation">,</span>sink<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 生成下个元素</span>
                    sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">&quot;3 x &quot;</span> <span class="token operator">+</span> state <span class="token operator">+</span> <span class="token string">&quot; = &quot;</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 返回新状态</span>
                    <span class="token keyword">return</span> state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// finally 消费状态</span>
                state <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;state = &quot;</span> <span class="token operator">+</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="异步创建流"><a href="#异步创建流" class="header-anchor">#</a> 异步创建流</h3> <p>与generate不同的是, 它的生成方式既可以同步也可以异步, 还可以每次发出多个元素. 同时create不需要状态值.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">interface</span> <span class="token class-name">MyEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">onDataChunk</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">processComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bridge <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>sink <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            myEventProcessor<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">MyEventListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataChunk</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment">// 可以多次调用next方法生成元素</span>
                                sink<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            sink<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>上述代码中sink的next与complete都是在myEventProcessor异步执行的.</p> <p>同时create方法还可以提供背压策略.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    
	<span class="token keyword">enum</span> <span class="token class-name">OverflowStrategy</span> <span class="token punctuation">{</span>
		
		<span class="token comment">// 完全忽略下游背压请求，这可能会在下游队列积满的时候导致 IllegalStateException。</span>
		<span class="token constant">IGNORE</span><span class="token punctuation">,</span>
        <span class="token comment">// 当下游跟不上节奏的时候发出一个 IllegalStateException 的错误信号。</span>
		<span class="token constant">ERROR</span><span class="token punctuation">,</span>
		<span class="token comment">// 当下游没有准备好接收新的元素的时候抛弃这个元素。</span>
		<span class="token constant">DROP</span><span class="token punctuation">,</span>
		<span class="token comment">// 让下游只得到上游最新的元素。</span>
		<span class="token constant">LATEST</span><span class="token punctuation">,</span>
		<span class="token comment">// （默认的）缓存所有下游没有来得及处理的元素（这个不限大小的缓存可能导致 OutOfMemoryError）。</span>
		<span class="token constant">BUFFER</span>
	<span class="token punctuation">}</span>    
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">FluxSink</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> emitter<span class="token punctuation">,</span> <span class="token class-name">OverflowStrategy</span> backpressure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">onAssembly</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FluxCreate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>emitter<span class="token punctuation">,</span> backpressure<span class="token punctuation">,</span> <span class="token class-name">FluxCreate<span class="token punctuation">.</span>CreateMode</span><span class="token punctuation">.</span><span class="token constant">PUSH_PULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="custom-block tip"><p class="title">注意</p><p>Mono 也有一个用于 create 的生成器（generator）—— MonoSink，它不能生成多个元素， 因此会抛弃第一个元素之后的所有元素。</p></div><h3 id="订阅流"><a href="#订阅流" class="header-anchor">#</a> 订阅流</h3> <p>Flux与Mono提供了一系列重载的接收lambda的subscribe方法. 除接收Subscription参数的重载方法之外, 他们都会在订阅
之后发出<code>request(Long.MAX_VALUE)</code>请求.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mono <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 无限制消费数据</span>
        mono<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 无限制消费数据, 并可以处理error</span>
        mono<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span><span class="token class-name">Throwable</span><span class="token operator">::</span><span class="token function">printStackTrace</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 无限制消费数据, 并可以处理error和complete</span>
        mono<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span><span class="token class-name">Throwable</span><span class="token operator">::</span><span class="token function">printStackTrace</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订阅后请求消费一个数据,而后取消订阅 </span>
        mono<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span>
                <span class="token class-name">Throwable</span><span class="token operator">::</span><span class="token function">printStackTrace</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                subscription <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>subscription<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 同上</span>
        mono<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Subscriber</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                s<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                t<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;completed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><div class="custom-block warning"><p class="title">注意</p><p>如果订阅者在流完成之前取消了订阅, 那么订阅者将不会收到complete信号</p></div><div class="custom-block danger"><p class="title">注意</p><p>不要在onSubscribe调用 subscription.cancel(). 会导致cancel()之前的request(n)失效. onNext会一个元素也接收不到</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSubscribe</span><span class="token punctuation">(</span><span class="token class-name">Subscription</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                subscription <span class="token operator">=</span> s<span class="token punctuation">;</span>
                s<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                s<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div><h2 id="操作符"><a href="#操作符" class="header-anchor">#</a> 操作符</h2> <h3 id="创建一个新序列"><a href="#创建一个新序列" class="header-anchor">#</a> 创建一个新序列</h3> <ul><li><p>发出一个 T，我已经有了：just</p> <ul><li><p>基于一个 Optional&lt;T&gt;：Mono#justOrEmpty(Optional&lt;T&gt;)</p></li> <li><p>基于一个可能为 null 的 T：Mono#justOrEmpty(T)</p></li></ul></li> <li><p>发出一个 T，且还是由 just 方法返回</p> <ul><li>但是“懒”创建的：使用 Mono#fromSupplier 或用 defer 包装 just</li></ul></li> <li><p>发出许多 T，这些元素我可以明确列举出来：Flux#just(T...)</p></li> <li><p>基于迭代数据结构:</p> <ul><li><p>一个数组：Flux#fromArray</p></li> <li><p>一个集合或 iterable：Flux#fromIterable</p></li> <li><p>一个 Integer 的 range：Flux#range</p></li> <li><p>一个 Stream 提供给每一个订阅：Flux#fromStream(Supplier&lt;Stream&gt;)</p></li></ul></li> <li><p>基于一个参数值给出的源：</p> <ul><li><p>一个 Supplier&lt;T&gt;：Mono#fromSupplier</p></li> <li><p>一个任务：Mono#fromCallable，Mono#fromRunnable</p></li></ul></li> <li><p>一个 CompletableFuture&lt;T&gt;：Mono#fromFuture</p></li> <li><p>直接完成：empty</p></li> <li><p>立即生成错误：error</p> <ul><li>但是“懒”的方式生成 Throwable：error(Supplier&lt;Throwable&gt;)</li></ul></li> <li><p>什么都不做：never</p> <ul><li>订阅时才决定：defer</li></ul></li> <li><p>依赖一个可回收的资源：using</p></li> <li><p>可编程地生成事件（可以使用状态）:</p> <ul><li><p>同步且逐个的：Flux#generate</p></li> <li><p>异步（也可同步）的，每次尽可能多发出元素：Flux#create （Mono#create 也是异步的，只不过只能发一个）</p></li></ul></li></ul> <h3 id="对序列进行转化"><a href="#对序列进行转化" class="header-anchor">#</a> 对序列进行转化</h3> <ul><li><p>我想转化一个序列：</p> <ul><li><p>1对1地转化（比如字符串转化为它的长度）：map</p></li> <li><p>​类型转化：cast</p></li> <li><p>​为了获得每个元素的序号：Flux#index</p></li> <li><p>1对n地转化（如字符串转化为一串字符）：flatMap + 使用一个工厂方法</p></li> <li><p>1对n地转化可自定义转化方法和/或状态：handle</p></li> <li><p>对每一个元素执行一个异步操作（如对 url 执行 http 请求）：flatMap + 一个异步的返回类型为 Publisher 的方法</p></li> <li><p>​忽略一些数据：在 flatMap lambda 中根据条件返回一个 Mono.empty()</p></li> <li><p>​保留原来的序列顺序：Flux#flatMapSequential（对每个元素的异步任务会立即执行，但会将结果按照原序列顺序排序）</p></li> <li><p>​当 Mono 元素的异步任务会返回多个元素的序列时：Mono#flatMapMany</p></li></ul></li> <li><p>我想添加一些数据元素到一个现有的序列：</p> <ul><li><p>在开头添加：Flux#startWith(T...)</p></li> <li><p>在最后添加：Flux#concatWith(T...)</p></li> <li><p>我想将 Flux 转化为集合（一下都是针对 Flux 的）</p></li> <li><p>转化为 List：collectList，collectSortedList</p></li> <li><p>转化为 Map：collectMap，collectMultiMap</p></li> <li><p>转化为自定义集合：collect</p></li> <li><p>计数：count</p></li> <li><p>reduce 算法（将上个元素的reduce结果与当前元素值作为输入执行reduce方法，如sum） reduce</p> <ul><li>​将每次 reduce 的结果立即发出：scan</li></ul></li> <li><p>转化为一个 boolean 值：</p> <ul><li><p>对所有元素判断都为true：all</p></li> <li><p>对至少一个元素判断为true：any</p></li> <li><p>判断序列是否有元素（不为空）：hasElements</p></li> <li><p>判断序列中是否有匹配的元素：hasElement</p></li></ul></li></ul></li> <li><p>我想合并 publishers</p> <ul><li><p>按序连接：Flux#concat 或 .concatWith(other)</p> <ul><li><p>​即使有错误，也会等所有的 publishers 连接完成：Flux#concatDelayError</p></li> <li><p>​按订阅顺序连接（这里的合并仍然可以理解成序列的连接）：Flux#mergeSequential</p></li></ul></li> <li><p>按元素发出的顺序合并（无论哪个序列的，元素先到先合并）：Flux#merge / .mergeWith(other)</p> <ul><li>​元素类型会发生变化：Flux#zip / Flux#zipWith</li></ul></li> <li><p>将元素组合：</p> <ul><li><p>2个 Monos 组成1个 Tuple2：Mono#zipWith</p></li> <li><p>n个 Monos 的元素都发出来后组成一个 Tuple：Mono#zip</p></li></ul></li> <li><p>在终止信号出现时“采取行动”</p> <ul><li><p>在 Mono 终止时转换为一个 Mono&lt;Void&gt;：Mono#and</p></li> <li><p>当 n 个 Mono 都终止时返回 Mono&lt;Void&gt;：Mono#when</p></li> <li><p>返回一个存放组合数据的类型，对于被合并的多个序列：</p> <ul><li><p>每个序列都发出一个元素时：Flux#zip</p></li> <li><p>任何一个序列发出元素时：Flux#combineLatest</p></li></ul></li></ul></li> <li><p>只取各个序列的第一个元素：Flux#first，Mono#first，mono.or (otherMono).or(thirdMono)，`flux.or(otherFlux).or(thirdFlux)</p></li> <li><p>由一个序列触发（类似于 flatMap，不过“喜新厌旧”）：switchMap</p></li> <li><p>由每个新序列开始时触发（也是“喜新厌旧”风格）：switchOnNext</p></li></ul></li> <li><p>我想重复一个序列：repeat</p> <ul><li><p>但是以一定的间隔重复：Flux.interval(duration).flatMap(tick -&gt; myExistingPublisher)</p></li> <li><p>我有一个空序列，但是…​</p> <ul><li><p>我想要一个缺省值来代替：defaultIfEmpty</p></li> <li><p>我想要一个缺省的序列来代替：switchIfEmpty</p></li></ul></li> <li><p>我有一个序列，但是我对序列的元素值不感兴趣：ignoreElements</p> <ul><li><p>​并且我希望用 Mono 来表示序列已经结束：then</p></li> <li><p>​并且我想在序列结束后等待另一个任务完成：thenEmpty</p></li> <li><p>​并且我想在序列结束之后返回一个 Mono：Mono#then(mono)</p></li> <li><p>​并且我想在序列结束之后返回一个值：Mono#thenReturn(T)</p></li> <li><p>​并且我想在序列结束之后返回一个 Flux：thenMany</p></li></ul></li> <li><p>我有一个 Mono 但我想延迟完成…​</p> <ul><li><p>当有1个或N个其他 publishers 都发出（或结束）时才完成：Mono#delayUntilOther</p> <ul><li>​使用一个函数式来定义如何获取“其他 publisher”：Mono#delayUntil(Function)</li></ul></li></ul></li> <li><p>我想基于一个递归的生成序列的规则扩展每一个元素，然后合并为一个序列发出：</p> <ul><li><p>​广度优先：expand(Function)</p></li> <li><p>​深度优先：expandDeep(Function)</p></li></ul></li></ul></li></ul> <h3 id="窥视-只读-序列"><a href="#窥视-只读-序列" class="header-anchor">#</a> “窥视”（只读）序列</h3> <ul><li><p>再不对序列造成改变的情况下，我想：</p> <ul><li><p>得到通知或执行一些操作：</p> <ul><li><p>发出元素：doOnNext</p></li> <li><p>序列完成：Flux#doOnComplete，Mono#doOnSuccess</p></li> <li><p>因错误终止：doOnError</p></li> <li><p>取消：doOnCancel</p></li> <li><p>订阅时：doOnSubscribe</p></li> <li><p>请求时：doOnRequest</p></li> <li><p>完成或错误终止：doOnTerminate（Mono的方法可能包含有结果）</p> <ul><li>但是在终止信号向下游传递 之后 ：doAfterTerminate</li></ul></li> <li><p>所有类型的信号（Signal）：Flux#doOnEach</p></li> <li><p>所有结束的情况（完成complete、错误error、取消cancel）：doFinally</p></li></ul></li> <li><p>记录日志：log</p></li></ul></li> <li><p>我想知道所有的事件:</p> <ul><li><p>每一个事件都体现为一个 single 对象：</p> <ul><li><p>执行 callback：doOnEach</p></li> <li><p>每个元素转化为 single 对象：materialize</p> <ul><li>​在转化回元素：dematerialize</li></ul></li></ul></li> <li><p>转化为一行日志：log</p></li></ul></li></ul> <h3 id="过滤序列"><a href="#过滤序列" class="header-anchor">#</a> 过滤序列</h3> <ul><li><p>我想过滤一个序列</p> <ul><li><p>基于给定的判断条件：filter</p> <ul><li>​异步地进行判断：filterWhen</li></ul></li> <li><p>仅限于指定类型的对象：ofType</p></li> <li><p>忽略所有元素：ignoreElements</p></li> <li><p>去重:</p> <ul><li><p>对于整个序列：Flux#distinct</p></li> <li><p>去掉连续重复的元素：Flux#distinctUntilChanged</p></li></ul></li></ul></li> <li><p>我只想要一部分序列：</p> <ul><li><p>只要 N 个元素：</p> <ul><li><p>从序列的第一个元素开始算：Flux#take(long)</p> <ul><li><p>​取一段时间内发出的元素：Flux#take(Duration)</p></li> <li><p>​只取第一个元素放到 Mono 中返回：Flux#next()</p></li> <li><p>​使用 request(N) 而不是取消：Flux#limitRequest(long)</p></li></ul></li> <li><p>从序列的最后一个元素倒数：Flux#takeLast</p></li> <li><p>直到满足某个条件（包含）：Flux#takeUntil（基于判断条件），Flux#takeUntilOther（基于对 publisher 的比较）</p></li> <li><p>直到满足某个条件（不包含）：Flux#takeWhile</p></li></ul></li> <li><p>最多只取 1 个元素：</p> <ul><li><p>给定序号：Flux#elementAt</p></li> <li><p>最后一个：.takeLast(1)</p> <ul><li><p>​如果为序列空则发出错误信号：Flux#last()</p></li> <li><p>​如果序列为空则返回默认值：Flux#last(T)</p></li></ul></li></ul></li> <li><p>跳过一些元素：</p> <ul><li><p>从序列的第一个元素开始跳过：Flux#skip(long)</p> <ul><li>​跳过一段时间内发出的元素：Flux#skip(Duration)</li></ul></li> <li><p>跳过最后的 n 个元素：Flux#skipLast</p></li> <li><p>直到满足某个条件（包含）：Flux#skipUntil（基于判断条件），Flux#skipUntilOther （基于对 publisher 的比较）</p></li> <li><p>直到满足某个条件（不包含）：Flux#skipWhile</p></li></ul></li> <li><p>采样：</p> <ul><li><p>给定采样周期：Flux#sample(Duration)</p> <ul><li>取采样周期里的第一个元素而不是最后一个：sampleFirst</li></ul></li> <li><p>基于另一个 publisher：Flux#sample(Publisher)</p></li> <li><p>基于 publisher“超时”：Flux#sampleTimeout （每一个元素会触发一个 publisher，如果这个 publisher 不被下一个元素触发的 publisher 覆盖就发出这个元素）</p></li></ul></li></ul></li> <li><p>我只想要一个元素（如果多于一个就返回错误）…​</p> <ul><li><p>如果序列为空，发出错误信号：Flux#single()</p></li> <li><p>如果序列为空，发出一个缺省值：Flux#single(T)</p></li> <li><p>如果序列为空就返回一个空序列：Flux#singleOrEmpty</p></li></ul></li></ul> <h3 id="错误处理"><a href="#错误处理" class="header-anchor">#</a> 错误处理</h3> <ul><li><p>我想创建一个错误序列：error…​</p> <ul><li><p>替换一个完成的 Flux：.concat(Flux.error(e))</p></li> <li><p>​替换一个完成的 Mono：.then(Mono.error(e))</p></li> <li><p>​如果元素超时未发出：timeout</p></li> <li><p>​“懒”创建：error(Supplier&lt;Throwable&gt;)</p></li></ul></li> <li><p>我想要类似 try/catch 的表达方式：</p> <ul><li><p>抛出异常：error</p></li> <li><p>捕获异常：</p> <ul><li><p>然后返回缺省值：onErrorReturn</p></li> <li><p>然后返回一个 Flux 或 Mono：onErrorResume</p></li> <li><p>包装异常后再抛出：.onErrorMap(t -&gt; new RuntimeException(t))</p></li></ul></li> <li><p>finally 代码块：doFinally</p></li> <li><p>Java 7 之后的 try-with-resources 写法：using 工厂方法</p></li></ul></li> <li><p>我想从错误中恢复…</p> <ul><li><p>返回一个缺省的：</p> <ul><li><p>的值：onErrorReturn</p></li> <li><p>Publisher：Flux#onErrorResume 和 Mono#onErrorResume</p></li></ul></li> <li><p>重试：retry</p> <ul><li>​由一个用于伴随 Flux 触发：retryWhen</li></ul></li></ul></li> <li><p>我想处理回压错误（向上游发出“MAX”的 request，如果下游的 request 比较少，则应用策略）…​</p> <ul><li><p>抛出 IllegalStateException：Flux#onBackpressureError</p></li> <li><p>丢弃策略：Flux#onBackpressureDrop</p> <ul><li>​但是不丢弃最后一个元素：Flux#onBackpressureLatest</li></ul></li> <li><p>缓存策略（有限或无限）：Flux#onBackpressureBuffer</p> <ul><li>​当有限的缓存空间用满则应用给定策略：Flux#onBackpressureBuffer 带有策略 BufferOverflowStrategy</li></ul></li></ul></li></ul> <h3 id="基于时间的操作"><a href="#基于时间的操作" class="header-anchor">#</a> 基于时间的操作</h3> <ul><li><p>我想将元素转换为带有时间信息的 Tuple2&lt;Long, T&gt;…​</p> <ul><li><p>从订阅时开始：elapsed</p></li> <li><p>记录时间戳：timestamp</p></li></ul></li> <li><p>如果元素间延迟过长则中止序列：timeout</p></li> <li><p>以固定的周期发出元素：Flux#interval</p></li> <li><p>在一个给定的延迟后发出 0：static Mono.delay.</p></li> <li><p>我想引入延迟：</p> <ul><li><p>对每一个元素：Mono#delayElement，Flux#delayElements</p></li> <li><p>延迟订阅：delaySubscription</p></li></ul></li></ul> <h3 id="拆分-flux"><a href="#拆分-flux" class="header-anchor">#</a> 拆分 Flux</h3> <ul><li><p>我想将一个 Flux&lt;T&gt; 拆分为一个 Flux&lt;Flux&lt;T&gt;&gt;：</p> <ul><li><p>以个数为界：window(int)</p> <ul><li>​会出现重叠或丢弃的情况：window(int, int)</li></ul></li> <li><p>以时间为界：window(Duration)</p> <ul><li>​会出现重叠或丢弃的情况：window(Duration, Duration)</li></ul></li> <li><p>以个数或时间为界：windowTimeout(int, Duration)</p></li> <li><p>基于对元素的判断条件：windowUntil</p> <ul><li>​触发判断条件的元素会分到下一波（cutBefore 变量）：.windowUntil(predicate, true)</li> <li>​满足条件的元素在一波，直到不满足条件的元素发出开始下一波：windowWhile （不满足条件的元素会被丢弃）</li></ul></li> <li><p>通过另一个 Publisher 的每一个 onNext 信号来拆分序列：window(Publisher)，windowWhen</p></li></ul></li> <li><p>我想将一个 Flux&lt;T&gt; 的元素拆分到集合…​</p> <ul><li><p>拆分为一个一个的 List:</p> <ul><li><p>以个数为界：buffer(int)</p> <ul><li>​会出现重叠或丢弃的情况：buffer(int, int)</li></ul></li> <li><p>以时间为界：buffer(Duration)</p> <ul><li>​会出现重叠或丢弃的情况：buffer(Duration, Duration)</li></ul></li> <li><p>以个数或时间为界：bufferTimeout(int, Duration)</p></li> <li><p>基于对元素的判断条件：bufferUntil(Predicate)</p> <ul><li><p>​触发判断条件的元素会分到下一个buffer：.bufferUntil(predicate, true)</p></li> <li><p>​满足条件的元素在一个buffer，直到不满足条件的元素发出开始下一buffer：bufferWhile(Predicate)</p></li></ul></li> <li><p>通过另一个 Publisher 的每一个 onNext 信号来拆分序列：buffer(Publisher)，bufferWhen</p></li></ul></li> <li><p>拆分到指定类型的 &quot;collection&quot;：buffer(int, Supplier&lt;C&gt;)</p></li></ul></li> <li><p>我想将 Flux&lt;T&gt; 中具有共同特征的元素分组到子 Flux：groupBy(Function&lt;T,K&gt;) TIP：注意返回值是 Flux&lt;GroupedFlux&lt;K, T&gt;&gt;，每一个 GroupedFlux 具有相同的 key 值 K，可以通过 key() 方法获取。</p></li></ul> <h3 id="回到同步的世界"><a href="#回到同步的世界" class="header-anchor">#</a> 回到同步的世界</h3> <ul><li><p>我有一个 Flux&lt;T&gt;，我想：</p> <ul><li><p>在拿到第一个元素前阻塞：Flux#blockFirst</p> <ul><li>​并给出超时时限：Flux#blockFirst(Duration)</li></ul></li> <li><p>在拿到最后一个元素前阻塞（如果序列为空则返回 null）：Flux#blockLast</p> <ul><li>​并给出超时时限：Flux#blockLast(Duration)</li></ul></li> <li><p>同步地转换为 Iterable&lt;T&gt;：Flux#toIterable</p></li> <li><p>同步地转换为 Java 8 Stream&lt;T&gt;：Flux#toStream</p></li></ul></li> <li><p>我有一个 Mono&lt;T&gt;，我想：</p> <ul><li><p>在拿到元素前阻塞：Mono#block</p> <ul><li>​并给出超时时限：Mono#block(Duration)</li></ul></li> <li><p>转换为 CompletableFuture&lt;T&gt;：Mono#toFuture</p></li></ul></li></ul> <h2 id="调度器"><a href="#调度器" class="header-anchor">#</a> 调度器</h2> <p>Reactor， 就像 RxJava，也可以被认为是 并发无关（concurrency agnostic） 的。意思就是， 它并不强制要求任何并发模型。更进一步，它将选择权交给开发者。不过，它还是提供了一些方便 进行并发执行的库。</p> <p>在 Reactor 中，执行模式以及执行过程取决于所使用的 Scheduler。 Scheduler 是一个拥有广泛实现类的抽象接口。 Schedulers 类提供的静态方法用于达成如下的执行环境：</p> <ul><li><p>当前线程（<code>Schedulers.immediate()</code>）</p></li> <li><p>可重用的单线程（<code>Schedulers.single()</code>）。注意，这个方法对所有调用者都提供同一个线程来使用， 直到该调度器（Scheduler）被废弃。如果你想使用专一的线程，就对每一个调用使用 <code>Schedulers.newSingle()</code>。</p></li> <li><p>弹性线程池（<code>Schedulers.elastic()</code>。它根据需要创建一个线程池，重用空闲线程。线程池如果空闲时间过长 （默认为 60s）就会被废弃。对于 I/O 阻塞的场景比较适用。 <code>Schedulers.elastic()</code> 能够方便地给一个阻塞 的任务分配它自己的线程，从而不会妨碍其他任务和资源，见 如何包装一个同步阻塞的调用？。</p></li> <li><p>固定大小线程池（<code>Schedulers.parallel()</code>）。所创建线程池的大小与 CPU 个数等同。</p></li></ul> <p>此外，你还可以使用 <code>Schedulers.fromExecutorService(ExecutorService)</code> 基于现有的 ExecutorService 创建 Scheduler。你也可以使用 newXXX 方法来创建不同的调度器。比如 <code>Schedulers.newElastic(yourScheduleName)</code> 创建一个新的名为 yourScheduleName 的弹性调度器。</p> <p>&gt; 操作符基于非阻塞算法实现，从而可以利用到某些调度器的工作窃取（work stealing） 特性的好处。</p> <p>一些操作符默认会使用一个指定的调度器（通常也允许开发者调整为其他调度器）例如， 通过工厂方法 Flux.interval(Duration.ofMillis(300)) 生成的每 300ms 打点一次的 Flux&lt;Long&gt;， 默认情况下使用的是 Schedulers.parallel()，下边的代码演示了如何将其装换为 Schedulers.single()：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">newSingle</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Reactor 提供了两种在响应式链中调整调度器 Scheduler 的方法：<code>publishOn</code> 和 <code>subscribeOn</code>。 它们都接受一个 Scheduler 作为参数，从而可以改变调度器。但是 publishOn 在链中出现的位置 是有讲究的，而 subscribeOn 则无所谓。要理解它们的不同，你首先要理解 <strong>nothing happens until you subscribe()</strong>。</p> <p>在 Reactor 中，当你在操作链上添加操作符的时候，你可以根据需要在 Flux 和 Mono 的实现中包装其他的 Flux 和 Mono。一旦你订阅（subscribe）了它，一个 Subscriber 的链 就被创建了，一直向上到第一个 publisher 。这些对开发者是不可见的，开发者所能看到的是最外一层的 Flux （或 Mono）和 Subscription，但是具体的任务是在中间这些跟操作符相关的 subscriber 上处理的。</p> <p>基于此，我们仔细研究一下 publishOn 和 subscribeOn 这两个操作符：</p> <ul><li><p>publishOn 的用法和处于订阅链（subscriber chain）中的其他操作符一样。它将上游 信号传给下游，同时执行指定的调度器 Scheduler 的某个工作线程上的回调。 它会 <strong>改变后续的操作符的执行所在线程</strong> （直到下一个 publishOn 出现在这个链上）。</p></li> <li><p>subscribeOn 用于订阅（subscription）过程，作用于那个向上的订阅链（发布者在被订阅 时才激活，订阅的传递方向是向上游的）。所以，无论你把 subscribeOn 至于操作链的什么位置， 它都会影响到源头的线程执行环境（context）。 但是，它不会影响到后续的 publishOn，后者仍能够切换其后操作符的线程执行环境。</p></li></ul> <p>&gt; 只有操作链中最早的 subscribeOn 调用才算数</p> <h2 id="线程模型"><a href="#线程模型" class="header-anchor">#</a> 线程模型</h2> <p>Flux 和 Mono 不会创建线程。一些操作符，比如 publishOn，会创建线程。同时，作为一种任务共享形式， 这些操作符可能会从其他任务池（work pool）——如果其他任务池是空闲的话——那里“偷”线程。因此， 无论是 Flux、Mono 还是 Subscriber 都应该精于线程处理。它们依赖这些操作符来管理线程和任务池。</p> <p>publishOn 强制下一个操作符（很可能包括下一个的下一个…​）来运行在一个不同的线程上。 类似的，subscribeOn 强制上一个操作符（很可能包括上一个的上一个…​）来运行在一个不同的线程上。 记住，在你订阅（subscribe）前，你只是定义了处理流程，而没有启动发布者。基于此，Reactor 可以使用这些规则来决定如何执行操作链。然后，一旦你订阅了，整个流程就开始工作了。</p> <p>下边的例子演示了支持任务共享的多线程模型：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//创建一个有 10,000 个元素的 Flux。</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span> 
    <span class="token comment">//创建等同于 CPU 个数的线程（最小为4）。</span>
    <span class="token comment">// subscribe() 之前什么都不会发生。</span>
    <span class="token punctuation">.</span><span class="token function">publishOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Scheduler.parallel() 创建一个基于单线程 ExecutorService 的固定大小的任务线程池。 因为可能会有一个或两个线程导致问题，它总是至少创建 4 个线程。然后 publishOn 方法便共享了这些任务线程， 当 publishOn 请求元素的时候，会从任一个正在发出元素的线程那里获取元素。这样， 就是进行了任务共享（一种资源共享方式）。Reactor 还提供了好几种共享资源的方式，请参考 Schedulers。</p> <p>Scheduler.elastic() 也能创建线程，它能够很方便地创建专门的线程（以便跑一些可能会阻塞资源的任务， 比如一个同步服务），如<code>Mono.fromCallable</code></p> <p>内部机制保证了这些操作符能够借助自增计数器（incremental counters）和警戒条件（guard conditions） 以线程安全的方式工作。例如，如果我们有四个线程处理一个流（就像上边的例子），每一个请求会让计数器自增， 这样后续的来自不同线程的请求就能拿到正确的元素。</p> <h2 id="高级特性"><a href="#高级特性" class="header-anchor">#</a> 高级特性</h2> <h3 id="打包复用操作符"><a href="#打包复用操作符" class="header-anchor">#</a> 打包复用操作符</h3> <ol><li>使用transform操作符</li></ol> <p>transform 操作符可以将一段操作链封装为一个函数式（function）。这个函数式能在操作期（assembly time） 将被封装的操作链中的操作符还原并接入到调用 transform 的位置。这样做和直接将被封装的操作符 加入到链上的效果是一样的。示例如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Flux</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> filterAndMap <span class="token operator">=</span>
f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>color <span class="token operator">-&gt;</span> <span class="token operator">!</span>color<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;orange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;green&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;purple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>filterAndMap<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber to Transformed MapAndFilter: &quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出
blue
<span class="token class-name">Subscriber</span> <span class="token keyword">to</span> <span class="token class-name">Transformed</span> <span class="token class-name">MapAndFilter</span><span class="token operator">:</span> <span class="token constant">BLUE</span>
green
<span class="token class-name">Subscriber</span> <span class="token keyword">to</span> <span class="token class-name">Transformed</span> <span class="token class-name">MapAndFilter</span><span class="token operator">:</span> <span class="token constant">GREEN</span>
orange
purple
<span class="token class-name">Subscriber</span> <span class="token keyword">to</span> <span class="token class-name">Transformed</span> <span class="token class-name">MapAndFilter</span><span class="token operator">:</span> <span class="token constant">PURPLE</span>        
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>使用compose操作符</li></ol> <p>compose 操作符与 transform 类似，也能够将几个操作符封装到一个函数式中。 主要的区别就是，这个函数式作用到原始序列上的话，是 基于每一个订阅者的（on a per-subscriber basis） 。这意味着它对每一个 subscription 可以生成不同的操作链（通过维护一些状态值）。 如下例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AtomicInteger</span> ai <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Flux</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> filterAndMap <span class="token operator">=</span> f <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>color <span class="token operator">-&gt;</span> <span class="token operator">!</span>color<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;orange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>color <span class="token operator">-&gt;</span> <span class="token operator">!</span>color<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;purple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> composedFlux <span class="token operator">=</span>
<span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;green&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;purple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span>filterAndMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

composedFlux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber 1 to Composed MapAndFilter :&quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
composedFlux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber 2 to Composed MapAndFilter: &quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出
blue
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Composed</span> <span class="token class-name">MapAndFilter</span> <span class="token operator">:</span><span class="token constant">BLUE</span>
green
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Composed</span> <span class="token class-name">MapAndFilter</span> <span class="token operator">:</span><span class="token constant">GREEN</span>
orange
purple
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Composed</span> <span class="token class-name">MapAndFilter</span> <span class="token operator">:</span><span class="token constant">PURPLE</span>
blue
<span class="token class-name">Subscriber</span> <span class="token number">2</span> <span class="token keyword">to</span> <span class="token class-name">Composed</span> <span class="token class-name">MapAndFilter</span><span class="token operator">:</span> <span class="token constant">BLUE</span>
green
<span class="token class-name">Subscriber</span> <span class="token number">2</span> <span class="token keyword">to</span> <span class="token class-name">Composed</span> <span class="token class-name">MapAndFilter</span><span class="token operator">:</span> <span class="token constant">GREEN</span>
orange
<span class="token class-name">Subscriber</span> <span class="token number">2</span> <span class="token keyword">to</span> <span class="token class-name">Composed</span> <span class="token class-name">MapAndFilter</span><span class="token operator">:</span> <span class="token constant">ORANGE</span>
purple
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="hot-vs-cold"><a href="#hot-vs-cold" class="header-anchor">#</a> Hot vs Cold</h3> <p>到目前为止，我们一直认为 Flux（和 Mono）都是这样的：它们都代表了一种异步的数据序列， 在订阅（subscribe）之前什么都不会发生。</p> <p>但是实际上，广义上有两种发布者：“热”与“冷”（hot and cold）。</p> <p>（本文档）到目前介绍的其实都是 cold 家族的发布者。它们为每一个订阅（subscription） 都生成数据。如果没有创建任何订阅（subscription），那么就不会生成数据。</p> <p>试想一个 HTTP 请求：每一个新的订阅者都会触发一个 HTTP 调用，但是如果没有订阅者关心结果的话， 那就不会有任何调用。</p> <p>另一方面，热 发布者，不依赖于订阅者的数量。即使没有订阅者它们也会发出数据， 如果有一个订阅者接入进来，那么它就会收到订阅之后发出的元素。对于热发布者， 在你订阅它之前，确实已经发生了什么。</p> <p>just 是 Reactor 中少数几个“热”操作符的例子之一：它直接在组装期（assembly time） 就拿到数据，如果之后有谁订阅它，就重新发送数据给订阅者。再拿 HTTP 调用举例，如果给 just 传入的数据是一个 HTTP 调用的结果，那么之后在初始化 just 的时候才会进行唯一的一次网络调用。</p> <p>如果想将 just 转化为一种 冷 的发布者，你可以使用 defer。它能够将刚才例子中对 HTTP 的请求延迟到订阅时（这样的话，对于每一个新的订阅来说，都会发生一次网络调用）。</p> <div class="custom-block tip"><p class="title">Note</p><p>Reactor 中多数其他的 热 发布者是扩展自 Processor 的。</p></div><p>考虑其他两个例子，如下是第一个例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">fromIterable</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;green&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;orange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;purple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> s<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;o&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                          <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

source<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber 1: &quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
source<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber 2: &quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出
blue
green
orange
<span class="token class-name">Subscriber</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token constant">ORANGE</span>
purple
blue
green
orange
<span class="token class-name">Subscriber</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token constant">ORANGE</span>
purple
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>两个订阅者都触发了所有的颜色，因为每一个订阅者都会让构造 Flux 的操作符运行一次。</p> <p>将下边的例子与第一个例子对比：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">UnicastProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hotSource <span class="token operator">=</span> <span class="token class-name">UnicastProcessor</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> hotFlux <span class="token operator">=</span> hotSource<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">autoConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">toUpperCase</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


hotFlux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber 1 to Hot Source: &quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hotSource<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token string">&quot;blue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hotSource<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token string">&quot;green&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hotFlux<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>d <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Subscriber 2 to Hot Source: &quot;</span><span class="token operator">+</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

hotSource<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token string">&quot;orange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hotSource<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token string">&quot;purple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hotSource<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Hot</span> <span class="token class-name">Source</span><span class="token operator">:</span> <span class="token constant">BLUE</span>
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Hot</span> <span class="token class-name">Source</span><span class="token operator">:</span> <span class="token constant">GREEN</span>
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Hot</span> <span class="token class-name">Source</span><span class="token operator">:</span> <span class="token constant">ORANGE</span>
<span class="token class-name">Subscriber</span> <span class="token number">2</span> <span class="token keyword">to</span> <span class="token class-name">Hot</span> <span class="token class-name">Source</span><span class="token operator">:</span> <span class="token constant">ORANGE</span>
<span class="token class-name">Subscriber</span> <span class="token number">1</span> <span class="token keyword">to</span> <span class="token class-name">Hot</span> <span class="token class-name">Source</span><span class="token operator">:</span> <span class="token constant">PURPLE</span>
<span class="token class-name">Subscriber</span> <span class="token number">2</span> <span class="token keyword">to</span> <span class="token class-name">Hot</span> <span class="token class-name">Source</span><span class="token operator">:</span> <span class="token constant">PURPLE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>第一个订阅者收到了所有的四个颜色，第二个订阅者由于是在前两个颜色发出之后订阅的， 故而收到了之后的两个颜色，在输出中有两次 &quot;ORANGE&quot; 和 &quot;PURPLE&quot;。从这个例子可见， 无论是否有订阅者接入进来，这个 Flux 都会运行。</p> <h3 id="广播"><a href="#广播" class="header-anchor">#</a> 广播</h3> <p>有时候，你不仅想要延迟到某一个订阅者订阅之后才开始发出数据，可能还希望在多个订阅者 到齐 之后 才开始。</p> <p>ConnectableFlux 的用意便在于此。Flux API 中有两种主要的返回 ConnectableFlux 的方式：publish 和 replay。</p> <ul><li><p>publish 会尝试满足各个不同订阅者的需求（背压），并综合这些请求反馈给源。 尤其是如果有某个订阅者的需求为 0，publish 会 暂停 它对源的请求。</p></li> <li><p>replay 将对第一个订阅后产生的数据进行缓存，最多缓存数量取决于配置（时间/缓存大小）。 它会对后续接入的订阅者重新发送数据。</p></li></ul> <p>ConnectableFlux 提供了多种对下游订阅的管理。包括：</p> <ul><li><p>connect 当有足够的订阅接入后，可以对 flux 手动执行一次。它会触发对上游源的订阅。</p></li> <li><p>autoConnect(n) 与 connect 类似，不过是在有 n 个订阅的时候自动触发。</p></li> <li><p>refCount(n) 不仅能够在订阅者接入的时候自动触发，还会检测订阅者的取消动作。如果订阅者数量不够， 会将源“断开连接”，再有新的订阅者接入的时候才会继续“连上”源。</p></li> <li><p>refCount(int, Duration) 增加了一个 &quot;优雅的倒计时&quot;：一旦订阅者数量太低了，它会等待 Duration 的时间，如果没有新的订阅者接入才会与源“断开连接”。</p></li></ul> <p>示例如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
                           <span class="token punctuation">.</span><span class="token function">doOnSubscribe</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;subscribed to source&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ConnectableFlux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> co <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

co<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span> e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
co<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span> e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;done subscribing&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;will now connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

co<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

控制台输出
done subscribing
will now connect
subscribed <span class="token keyword">to</span> <span class="token namespace">source</span>
<span class="token number">1</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>使用autoConnect:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> source <span class="token operator">=</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
                           <span class="token punctuation">.</span><span class="token function">doOnSubscribe</span><span class="token punctuation">(</span>s <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;subscribed to source&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> autoCo <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">autoConnect</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

autoCo<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span> e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;subscribed first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;subscribing second&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
autoCo<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">,</span> e <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出
subscribed first
subscribing second
subscribed <span class="token keyword">to</span> <span class="token namespace">source</span>
<span class="token number">1</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">2</span>
<span class="token number">3</span>
<span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="批处理"><a href="#批处理" class="header-anchor">#</a> 批处理</h3> <p>当你有许多的元素，并且想将他们分批处理，Reactor 总体上有三种方案：分组（grouping）、 窗口（windowing）（译者注：感觉这个不翻译更明白。。。）、缓存（buffering）。 这三种在概念上类似，因为它们都是将 Flux&lt;T&gt; 进行聚集。分组和分段操作都会创建一个 Flux&lt;Flux&lt;T&gt;&gt;，而缓存操作得到的是一个 Collection&lt;T&gt;（译者注：应该是一个 Flux&lt;Collection&lt;T&gt;&gt;)。</p> <ol><li>用 Flux&lt;GroupedFlux&lt;T&gt;&gt; 进行分组</li></ol> <p>分组能够根据 key 将源 Flux&lt;T&gt; 拆分为多个批次。</p> <p>对应的操作符是 groupBy。</p> <p>每一组用 GroupedFlux&lt;T&gt; 类型表示，使用它的 key() 方法可以得到该组的 key。</p> <p>在组内，元素并不需要是连续的。当源发出一个新的元素，该元素会被分发到与之匹配的 key 所对应的组中（如果还没有该 key 对应的组，则创建一个）。</p> <p>这意味着组：</p> <div class="language- extra-class"><pre><code>1. 是互相没有交集的（一个元素只属于一个组）。
2. 会包含原始序列中任意位置的元素。
3. 不会为空。
</code></pre></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;even&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;odd&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">concatMap</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g<span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//如果组为空，显示为 -1</span>
                                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token operator">::</span><span class="token function">valueOf</span><span class="token punctuation">)</span> <span class="token comment">//转换为字符串</span>
                                <span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//以该组的 key 开头</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token string">&quot;odd&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;11&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;13&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token string">&quot;even&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;6&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;12&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-block warning"><p class="title">注意</p><p>分组操作适用于分组个数不多的场景。而且所有的组都必须被消费，这样 groupBy 才能持续从上游获取数据。有时候这两种要求在一起——比如元素数量超多， 但是并行的用来消费的 flatMap 又太少的时候——会导致程序卡死。</p></div><ol start="2"><li>使用 Flux&lt;Flux&lt;T&gt;&gt; 进行 window 操作
window 操作是 根据个数、时间等条件，或能够定义边界的发布者（boundary-defining Publisher）， 把源 Flux&lt;T&gt; 拆分为 windows。</li></ol> <p>对应的操作符有 window、windowTimeout、windowUntil、windowWhile，以及 windowWhen。</p> <p>与 groupBy 的主要区别在于，窗口操作能够保持序列顺序。并且同一时刻最多只能有两个 window 是开启的。</p> <p>它们 可以 重叠。操作符参数有 maxSize 和 skip，maxSize 指定收集多少个元素就关闭 window，而 skip 指定收集多数个元素后就打开下一个 window。所以如果 maxSize &gt; skip 的话， 一个新的 window 的开启会先于当前 window 的关闭， 从而二者会有重叠。</p> <p>重叠的 window 示例如下</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">//overlapping windows</span>
                <span class="token punctuation">.</span><span class="token function">concatMap</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g<span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//将 windows 显示为 -1</span>
        <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-block tip"><p class="title">注意</p><p>如果将两个参数的配置反过来（maxSize &lt; skip），序列中的一些元素就会被丢弃掉， 而不属于任何 window。</p></div><p>对基于判断条件的 windowUntil 和 windowWhile，如果序列中的元素不匹配判断条件， 那么可能导致 空 windows，如下例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">windowWhile</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">concatMap</span><span class="token punctuation">(</span>g <span class="token operator">-&gt;</span> g<span class="token punctuation">.</span><span class="token function">defaultIfEmpty</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">//分别被奇数 1 3 5 触发</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token comment">// 被 11 触发</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token comment">// 被 13 触发</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 空的 completion window，如果 onComplete 前的元素能够匹配上的话就没有这个了</span>
                <span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="3"><li>使用 Flux&lt;List&lt;T&gt;&gt; 进行缓存
缓存与窗口类似，不同在于：缓存操作之后会发出 buffers （类型为<code>Collection&amp;lt;T&amp;gt;， 默认是</code>List&lt;T&gt;)，而不是 windows （类型为 Flux&lt;T&gt;）。</li></ol> <p>缓存的操作符与窗口的操作符是对应的：buffer、bufferTimeout、bufferUntil、bufferWhile， 以及<code>bufferWhen</code>。</p> <p>如果说对于窗口操作符来说，是开启一个窗口，那么对于缓存操作符来说，就是创建一个新的集合， 然后对其添加元素。而窗口操作符在关闭窗口的时候，缓存操作符则是发出一个集合。</p> <p>缓存操作也会有丢弃元素或内容重叠的情况，如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 缓存重叠</span>
        <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>不像窗口方法，bufferUntil 和 bufferWhile 不会发出空的 buffer，如下例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">StepVerifier</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">bufferWhile</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span><span class="token punctuation">;</span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 被 11 触发</span>
        <span class="token punctuation">.</span><span class="token function">expectNext</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 被 13 触发</span>
        <span class="token punctuation">.</span><span class="token function">verifyComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="并行处理"><a href="#并行处理" class="header-anchor">#</a> 并行处理</h3> <p>如今多核架构已然普及，能够方便的进行并行处理是很重要的。Reactor 提供了一种特殊的类型 ParallelFlux 来实现并行，它能够将操作符调整为并行处理方式。</p> <p>你可以对任何 Flux 使用 parallel() 操作符来得到一个 ParallelFlux. 不过这个操作符本身并不会进行并行处理，而是将负载划分到多个“轨道（rails）”上 （默认情况下，轨道个数与 CPU 核数相等）。</p> <p>为了配置 ParallelFlux 如何并行地执行每一个轨道，你需要使用 runOn(Scheduler)。 注意，Schedulers.parallel() 是推荐的专门用于并行处理的调度器。
下边有两个用于比较的例子，第一个如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; -&gt; &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出
main <span class="token operator">-&gt;</span> <span class="token number">1</span>
main <span class="token operator">-&gt;</span> <span class="token number">2</span>
main <span class="token operator">-&gt;</span> <span class="token number">3</span>
main <span class="token operator">-&gt;</span> <span class="token number">4</span>
main <span class="token operator">-&gt;</span> <span class="token number">5</span>
main <span class="token operator">-&gt;</span> <span class="token number">6</span>
main <span class="token operator">-&gt;</span> <span class="token number">7</span>
main <span class="token operator">-&gt;</span> <span class="token number">8</span>
main <span class="token operator">-&gt;</span> <span class="token number">9</span>
main <span class="token operator">-&gt;</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>下边是第二个例子：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">runOn</span><span class="token punctuation">(</span><span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; -&gt; &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
控制台输出    
parallel<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">1</span>
parallel<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">2</span>
parallel<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">3</span>
parallel<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">4</span>
parallel<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">5</span>
parallel<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">6</span>
parallel<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">7</span>
parallel<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">9</span>
parallel<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">8</span>
parallel<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>如果在并行地处理之后，需要退回到一个“正常”的 Flux 而使后续的操作链按非并行模式执行， 你可以对 ParallelFlux 使用 sequential() 方法。</p> <p>注意，当你在对 ParallelFlux 使用一个 Subscriber 而不是基于 lambda 进行订阅（subscribe()） 的时候，sequential() 会自动地被偷偷应用。</p> <p>注意 <code>subscribe(Subscriber&lt;T&gt;)</code> 会合并所有的执行轨道，而 <code>subscribe(Consumer&lt;T&gt;)</code> 会在所有轨道上运行。
如果 subscribe() 方法中是一个 lambda，那么有几个轨道，lambda 就会被执行几次。</p> <p>你还可以使用 groups() 作为 <code>Flux&lt;GroupedFlux&lt;T&gt;&gt;</code> 进入到各个轨道或组里边， 然后可以通过 composeGroup() 添加额外的操作符。</p></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NiceAshin/my_blog/edit/main/java/reactive/projectreactor.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2/28/2026, 6:18:27 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#flux与mono" class="sidebar-link reco-side-flux与mono" data-v-b57cc07c>Flux与Mono</a></li><li class="level-2" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#创建与订阅" class="sidebar-link reco-side-创建与订阅" data-v-b57cc07c>创建与订阅</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#立即创建流" class="sidebar-link reco-side-立即创建流" data-v-b57cc07c>立即创建流</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#延迟创建流" class="sidebar-link reco-side-延迟创建流" data-v-b57cc07c>延迟创建流</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#周期生成无限流" class="sidebar-link reco-side-周期生成无限流" data-v-b57cc07c>周期生成无限流</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#生成流" class="sidebar-link reco-side-生成流" data-v-b57cc07c>生成流</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#异步创建流" class="sidebar-link reco-side-异步创建流" data-v-b57cc07c>异步创建流</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#订阅流" class="sidebar-link reco-side-订阅流" data-v-b57cc07c>订阅流</a></li><li class="level-2" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#操作符" class="sidebar-link reco-side-操作符" data-v-b57cc07c>操作符</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#创建一个新序列" class="sidebar-link reco-side-创建一个新序列" data-v-b57cc07c>创建一个新序列</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#对序列进行转化" class="sidebar-link reco-side-对序列进行转化" data-v-b57cc07c>对序列进行转化</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#窥视-只读-序列" class="sidebar-link reco-side-窥视-只读-序列" data-v-b57cc07c>“窥视”（只读）序列</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#过滤序列" class="sidebar-link reco-side-过滤序列" data-v-b57cc07c>过滤序列</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#错误处理" class="sidebar-link reco-side-错误处理" data-v-b57cc07c>错误处理</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#基于时间的操作" class="sidebar-link reco-side-基于时间的操作" data-v-b57cc07c>基于时间的操作</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#拆分-flux" class="sidebar-link reco-side-拆分-flux" data-v-b57cc07c>拆分 Flux</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#回到同步的世界" class="sidebar-link reco-side-回到同步的世界" data-v-b57cc07c>回到同步的世界</a></li><li class="level-2" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#调度器" class="sidebar-link reco-side-调度器" data-v-b57cc07c>调度器</a></li><li class="level-2" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#线程模型" class="sidebar-link reco-side-线程模型" data-v-b57cc07c>线程模型</a></li><li class="level-2" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#高级特性" class="sidebar-link reco-side-高级特性" data-v-b57cc07c>高级特性</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#打包复用操作符" class="sidebar-link reco-side-打包复用操作符" data-v-b57cc07c>打包复用操作符</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#hot-vs-cold" class="sidebar-link reco-side-hot-vs-cold" data-v-b57cc07c>Hot vs Cold</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#广播" class="sidebar-link reco-side-广播" data-v-b57cc07c>广播</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#批处理" class="sidebar-link reco-side-批处理" data-v-b57cc07c>批处理</a></li><li class="level-3" data-v-b57cc07c><a href="/java/reactive/projectreactor.html#并行处理" class="sidebar-link reco-side-并行处理" data-v-b57cc07c>并行处理</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.8218fb5d.js" defer></script><script src="/assets/js/3.a30b6709.js" defer></script><script src="/assets/js/1.3bd31195.js" defer></script><script src="/assets/js/103.740971e5.js" defer></script>
  </body>
</html>
