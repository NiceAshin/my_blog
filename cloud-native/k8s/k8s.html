<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>k8s快速入门 | AshinBlog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="黑夜中前行，仍照亮前路!">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.e853742c.css" as="style"><link rel="preload" href="/assets/js/app.bb57ff9a.js" as="script"><link rel="preload" href="/assets/js/3.a30b6709.js" as="script"><link rel="preload" href="/assets/js/1.cca03dd0.js" as="script"><link rel="preload" href="/assets/js/23.a13fd506.js" as="script"><link rel="prefetch" href="/assets/js/10.69e1aa51.js"><link rel="prefetch" href="/assets/js/100.a8f1ee96.js"><link rel="prefetch" href="/assets/js/101.9d567414.js"><link rel="prefetch" href="/assets/js/102.d1452359.js"><link rel="prefetch" href="/assets/js/103.740971e5.js"><link rel="prefetch" href="/assets/js/104.352bcdd6.js"><link rel="prefetch" href="/assets/js/105.8ef6c086.js"><link rel="prefetch" href="/assets/js/106.4f818e1a.js"><link rel="prefetch" href="/assets/js/107.559970d2.js"><link rel="prefetch" href="/assets/js/108.ab661542.js"><link rel="prefetch" href="/assets/js/109.39ff50ea.js"><link rel="prefetch" href="/assets/js/11.1b086bd8.js"><link rel="prefetch" href="/assets/js/110.341ee937.js"><link rel="prefetch" href="/assets/js/111.9f3fb1fc.js"><link rel="prefetch" href="/assets/js/112.022aa5dc.js"><link rel="prefetch" href="/assets/js/113.2aab82ec.js"><link rel="prefetch" href="/assets/js/114.5dd93947.js"><link rel="prefetch" href="/assets/js/115.ee1e0532.js"><link rel="prefetch" href="/assets/js/116.175f92bc.js"><link rel="prefetch" href="/assets/js/117.c88a30b8.js"><link rel="prefetch" href="/assets/js/118.7df9933d.js"><link rel="prefetch" href="/assets/js/119.07ea429a.js"><link rel="prefetch" href="/assets/js/12.dffcb3b7.js"><link rel="prefetch" href="/assets/js/120.e9836657.js"><link rel="prefetch" href="/assets/js/121.b81edf9b.js"><link rel="prefetch" href="/assets/js/122.51e43e7d.js"><link rel="prefetch" href="/assets/js/123.11bbdd7c.js"><link rel="prefetch" href="/assets/js/124.eeed61d1.js"><link rel="prefetch" href="/assets/js/125.4ae9b36f.js"><link rel="prefetch" href="/assets/js/126.fcf5a5af.js"><link rel="prefetch" href="/assets/js/127.a603163c.js"><link rel="prefetch" href="/assets/js/128.3d9a6c65.js"><link rel="prefetch" href="/assets/js/129.68e55c2f.js"><link rel="prefetch" href="/assets/js/13.c87ec0d4.js"><link rel="prefetch" href="/assets/js/130.103caf73.js"><link rel="prefetch" href="/assets/js/131.bf64f35f.js"><link rel="prefetch" href="/assets/js/132.319875d9.js"><link rel="prefetch" href="/assets/js/133.69881e20.js"><link rel="prefetch" href="/assets/js/134.6b9b54c2.js"><link rel="prefetch" href="/assets/js/14.ddf6b8b5.js"><link rel="prefetch" href="/assets/js/15.5359191f.js"><link rel="prefetch" href="/assets/js/16.1a0014c4.js"><link rel="prefetch" href="/assets/js/17.18d7c26b.js"><link rel="prefetch" href="/assets/js/18.97d1737b.js"><link rel="prefetch" href="/assets/js/19.83603dba.js"><link rel="prefetch" href="/assets/js/20.b9bd7960.js"><link rel="prefetch" href="/assets/js/21.1c57980d.js"><link rel="prefetch" href="/assets/js/22.fd6935f6.js"><link rel="prefetch" href="/assets/js/24.c8c53d68.js"><link rel="prefetch" href="/assets/js/25.ddff5762.js"><link rel="prefetch" href="/assets/js/26.02ddae21.js"><link rel="prefetch" href="/assets/js/27.362c51b6.js"><link rel="prefetch" href="/assets/js/28.dd12b3e6.js"><link rel="prefetch" href="/assets/js/29.6d6252bb.js"><link rel="prefetch" href="/assets/js/30.72b8c243.js"><link rel="prefetch" href="/assets/js/31.c5fd4a8b.js"><link rel="prefetch" href="/assets/js/32.d85e3431.js"><link rel="prefetch" href="/assets/js/33.eb02c4d3.js"><link rel="prefetch" href="/assets/js/34.9fcf3a56.js"><link rel="prefetch" href="/assets/js/35.493cb9fe.js"><link rel="prefetch" href="/assets/js/36.ddc4139b.js"><link rel="prefetch" href="/assets/js/37.5896d1ca.js"><link rel="prefetch" href="/assets/js/38.05c45e9d.js"><link rel="prefetch" href="/assets/js/39.f7e645e8.js"><link rel="prefetch" href="/assets/js/4.3808e766.js"><link rel="prefetch" href="/assets/js/40.071fbc1e.js"><link rel="prefetch" href="/assets/js/41.874656f9.js"><link rel="prefetch" href="/assets/js/42.ab33fbbd.js"><link rel="prefetch" href="/assets/js/43.8afd89bd.js"><link rel="prefetch" href="/assets/js/44.dc1daca4.js"><link rel="prefetch" href="/assets/js/45.32ce99c9.js"><link rel="prefetch" href="/assets/js/46.86e2edd8.js"><link rel="prefetch" href="/assets/js/47.cf6a45a1.js"><link rel="prefetch" href="/assets/js/48.33ad02a0.js"><link rel="prefetch" href="/assets/js/49.e3f07cd9.js"><link rel="prefetch" href="/assets/js/5.b659ac8f.js"><link rel="prefetch" href="/assets/js/50.44cf0c3c.js"><link rel="prefetch" href="/assets/js/51.ba7c8902.js"><link rel="prefetch" href="/assets/js/52.3914cb79.js"><link rel="prefetch" href="/assets/js/53.72dfe3fe.js"><link rel="prefetch" href="/assets/js/54.bf868281.js"><link rel="prefetch" href="/assets/js/55.0050143c.js"><link rel="prefetch" href="/assets/js/56.4b8a0053.js"><link rel="prefetch" href="/assets/js/57.c6162f9f.js"><link rel="prefetch" href="/assets/js/58.7dd6dff9.js"><link rel="prefetch" href="/assets/js/59.91fd2a15.js"><link rel="prefetch" href="/assets/js/6.82e5b679.js"><link rel="prefetch" href="/assets/js/60.81e59a18.js"><link rel="prefetch" href="/assets/js/61.36c57dbf.js"><link rel="prefetch" href="/assets/js/62.693063e7.js"><link rel="prefetch" href="/assets/js/63.6e08f720.js"><link rel="prefetch" href="/assets/js/64.dd52b51b.js"><link rel="prefetch" href="/assets/js/65.5104bb23.js"><link rel="prefetch" href="/assets/js/66.062455e7.js"><link rel="prefetch" href="/assets/js/67.28c57bb5.js"><link rel="prefetch" href="/assets/js/68.19b5630c.js"><link rel="prefetch" href="/assets/js/69.a4d9a9f3.js"><link rel="prefetch" href="/assets/js/7.1802b96c.js"><link rel="prefetch" href="/assets/js/70.9af7cf2a.js"><link rel="prefetch" href="/assets/js/71.20ede5ab.js"><link rel="prefetch" href="/assets/js/72.6d8e2045.js"><link rel="prefetch" href="/assets/js/73.ac30978d.js"><link rel="prefetch" href="/assets/js/74.951efe84.js"><link rel="prefetch" href="/assets/js/75.e5c3f364.js"><link rel="prefetch" href="/assets/js/76.27cf86a8.js"><link rel="prefetch" href="/assets/js/77.8c4c0354.js"><link rel="prefetch" href="/assets/js/78.151ec9e5.js"><link rel="prefetch" href="/assets/js/79.44946107.js"><link rel="prefetch" href="/assets/js/8.4b6e007f.js"><link rel="prefetch" href="/assets/js/80.8777d920.js"><link rel="prefetch" href="/assets/js/81.857b4f50.js"><link rel="prefetch" href="/assets/js/82.64d7b72e.js"><link rel="prefetch" href="/assets/js/83.a42c835a.js"><link rel="prefetch" href="/assets/js/84.016d560f.js"><link rel="prefetch" href="/assets/js/85.3403cbd5.js"><link rel="prefetch" href="/assets/js/86.59898fab.js"><link rel="prefetch" href="/assets/js/87.ba9a9d37.js"><link rel="prefetch" href="/assets/js/88.c325c789.js"><link rel="prefetch" href="/assets/js/89.c3fe56bd.js"><link rel="prefetch" href="/assets/js/9.86bf551b.js"><link rel="prefetch" href="/assets/js/90.176a16c9.js"><link rel="prefetch" href="/assets/js/91.3897db10.js"><link rel="prefetch" href="/assets/js/92.778b9b6a.js"><link rel="prefetch" href="/assets/js/93.d4669ef0.js"><link rel="prefetch" href="/assets/js/94.6aaa086e.js"><link rel="prefetch" href="/assets/js/95.66b8e863.js"><link rel="prefetch" href="/assets/js/96.eca88322.js"><link rel="prefetch" href="/assets/js/97.a0d1bdf0.js"><link rel="prefetch" href="/assets/js/98.58ea5755.js"><link rel="prefetch" href="/assets/js/99.513ff1d6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e853742c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>AshinBlog</h3> <p class="description" data-v-59e6cb88>黑夜中前行，仍照亮前路!</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>AshinZhang</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2026
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="AshinBlog" class="logo"> <span class="site-name">AshinBlog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      架构与设计思想
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ddd/" class="nav-link"><i class="undefined"></i>
  领域驱动设计
</a></li><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link"><i class="undefined"></i>
  微服务实践
</a></li><li class="dropdown-item"><!----> <a href="/design/" class="nav-link"><i class="undefined"></i>
  设计模式手册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      编程语言与响应式开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link"><i class="undefined"></i>
  Java 技术栈
</a></li><li class="dropdown-item"><!----> <a href="/go/" class="nav-link"><i class="undefined"></i>
  Go 语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      平台工程与基础设施
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link"><i class="undefined"></i>
  Docker 入门与部署
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link router-link-active"><i class="undefined"></i>
  云原生实践
</a></li><li class="dropdown-item"><!----> <a href="/ground/" class="nav-link"><i class="undefined"></i>
  中间件运维
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link"><i class="undefined"></i>
  Linux 运维手册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      AI 与智能工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/" class="nav-link"><i class="undefined"></i>
  AI 实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程实战与知识库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/#问题排查与经验" class="nav-link"><i class="undefined"></i>
  问题排查与经验
</a></li><li class="dropdown-item"><!----> <a href="/more/#项目与配置实战" class="nav-link"><i class="undefined"></i>
  项目与配置实战
</a></li><li class="dropdown-item"><!----> <a href="/more/#接口文档专区" class="nav-link"><i class="undefined"></i>
  接口文档专区
</a></li></ul></div></div> <a href="https://github.com/NiceAshin" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    AshinZhang
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>119</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>35</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      架构与设计思想
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ddd/" class="nav-link"><i class="undefined"></i>
  领域驱动设计
</a></li><li class="dropdown-item"><!----> <a href="/microservice/" class="nav-link"><i class="undefined"></i>
  微服务实践
</a></li><li class="dropdown-item"><!----> <a href="/design/" class="nav-link"><i class="undefined"></i>
  设计模式手册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      编程语言与响应式开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link"><i class="undefined"></i>
  Java 技术栈
</a></li><li class="dropdown-item"><!----> <a href="/go/" class="nav-link"><i class="undefined"></i>
  Go 语言
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      平台工程与基础设施
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link"><i class="undefined"></i>
  Docker 入门与部署
</a></li><li class="dropdown-item"><!----> <a href="/cloud-native/" class="nav-link router-link-active"><i class="undefined"></i>
  云原生实践
</a></li><li class="dropdown-item"><!----> <a href="/ground/" class="nav-link"><i class="undefined"></i>
  中间件运维
</a></li><li class="dropdown-item"><!----> <a href="/linux/" class="nav-link"><i class="undefined"></i>
  Linux 运维手册
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      AI 与智能工具
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ai/" class="nav-link"><i class="undefined"></i>
  AI 实践
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程实战与知识库
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/#问题排查与经验" class="nav-link"><i class="undefined"></i>
  问题排查与经验
</a></li><li class="dropdown-item"><!----> <a href="/more/#项目与配置实战" class="nav-link"><i class="undefined"></i>
  项目与配置实战
</a></li><li class="dropdown-item"><!----> <a href="/more/#接口文档专区" class="nav-link"><i class="undefined"></i>
  接口文档专区
</a></li></ul></div></div> <a href="https://github.com/NiceAshin" target="_blank" rel="noopener noreferrer" class="repo-link"><i class="iconfont reco-github"></i>
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>AshinZhang</span>
          
        <span data-v-59e6cb88>2020 - </span>
        2026
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">k8s快速入门</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>AshinZhang</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>7/25/2020</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="k8s快速入门"><a href="#k8s快速入门" class="header-anchor">#</a> k8s快速入门</h1> <blockquote><p>预计阅读时间：52 分钟</p></blockquote> <blockquote><p>本文为The kubernetes book的笔记. 作者Nigel Poulton, 译者<a href="https://github.com/get-set" target="_blank" rel="noopener noreferrer">刘康<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>K8s是一个应用编排器, 可以部署应用, 动态扩缩容, 故障自愈, 不停机回滚, 同时还是一个支撑应用运行的集群, 集群由一个或多个主节点和若干个工作节点构成. 集群内部的
DNS服务还提供了服务发现与负载均衡的能力.</p> <p>k8s与容器技术是互补的技术, 容器用于应用的开发. k8s用于应用编排.</p> <h2 id="节点"><a href="#节点" class="header-anchor">#</a> 节点</h2> <p>集群由一个或多个主节点和若干个工作节点构成. 其中主节点负责管理整个集群, 做调度决策, 监控集群, 响应事件的工作. 工作节点负责运行应用服务, 每个工作节点都有自己的主节点.</p> <p><img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s.svg" alt="k8s"></p> <h3 id="主节点"><a href="#主节点" class="header-anchor">#</a> 主节点</h3> <p><img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-master-node.png" alt="master-node"></p> <p>k8s的主节点(或者说控制平面, 官方文档是这么称呼的)通常有一个或多个系统服务组成.  他为集群提供了故障转移和高可用性.</p> <ul><li><strong>API Server</strong></li></ul> <p>k8s中所有的组件之间都通过API Server进行通信. API Server默认是一组RESTful风格的接口.</p> <p>API Server位于控制平面的最前端, 所有的指令与通信都需要通过API Server来完成.</p> <ul><li><strong>集群存储</strong></li></ul> <p>k8s默认使用etcd存储着整个集群的配置和状态, etcd更注重一致性.</p> <ul><li><strong>Controller Manager</strong></li></ul> <p>Controller用于确保集群的当前状态与预期状态相匹配. Controller有很多个, 比如终端Controller, 工作节点Controller, 副本Controller(一般指Pod副本). 每个Controller都在后台启动独立的
循环监听功能.</p> <div class="custom-block tip"><p class="title">循环监听逻辑</p><ol><li>获取期望状态</li> <li>观察当前状态</li> <li>对比状态</li> <li>调整差异使当前状态去尽量符合期望状态</li></ol></div><p>Controller Manager负责创建Controller并监控他们的执行.</p> <ul><li><strong>Scheduler</strong></li></ul> <p>调度器监听API Server来启动新的工作任务, 并将其分配到合适的节点中, 合适与否由调度器判定. 判定条件有:节点是否存活, 任务依赖端口在节点中是否可用, 节点是否还有足够资源等等.</p> <ul><li><strong>Cloud Controller Manager</strong></li></ul> <p>如果集群运行在公有云平台, 控制平面会启动一个Cloud Controller Manager来负责集成底层的公有云服务. 如实例, 负载均衡等.</p> <h3 id="工作节点"><a href="#工作节点" class="header-anchor">#</a> 工作节点</h3> <p>工作节点托管作为应用负载的Pod.</p> <ul><li><strong>kubelet</strong></li></ul> <p>kubelet是工作节点的核心, 新的工作节点加入集群后, kubelet就会被部署到新节点上.</p> <p>kubelet负责向集群汇报当前节点的资源状态, 如CPU, 内存等.</p> <p>kubelet还会监听API Server分配的新任务, 每监听到一个就去执行这个任务, 并且与主节点维护一个通信频道, 当任务结束后返回执行结果.</p> <ul><li><strong>Container Runtime</strong></li></ul> <p>容器运行时供kubelet使用, 用于执行依赖容器的任务. 容器运行时可以由docker提供, 也可以由containerd或其他容器技术提供.</p> <blockquote><p>containerd是docker的精简版, 在某些时候更适合作为k8s的容器运行时.</p></blockquote> <ul><li><strong>kube-proxy</strong></li></ul> <p>kube-proxy与kubelet和Container Runtime一样在每个工作节点中都存在, 它是维护节点上的网络规则, 允许从集群内部或外部与Pod进行网络通信.</p> <h2 id="dns-网络"><a href="#dns-网络" class="header-anchor">#</a> DNS/网络</h2> <p>K8s有自己的DNS, 他有一个静态IP, 并且被硬编码在每个节点中. 他让我们可以使用一致的DNS名称而非IP地址来访问服务. 集群中的每个Service都会有一个DNS名称.</p> <h2 id="声明式模型"><a href="#声明式模型" class="header-anchor">#</a> 声明式模型</h2> <p>当我们要将一个应用运行在k8s上时, 通常需要先将应用打包为镜像, 然后封装到pod中去运行. 我们可以通过定义manifest文件(yml)的方式去部署.</p> <p>我们在yml中告知k8s集群我们希望的应用运行状态. 也就是期望状态. 比如运行多少个副本. 然后提交到k8s中. k8s会确保应用的运行符合我们的期望状态.</p> <p>整个流程如下:</p> <ol><li>在mainfest文件中声明一个应用的期望达到的状态</li> <li>将manifest文件发送到API服务</li> <li>k8s将manifest存储到集群存储中, 并作为应用的期望状态</li> <li>k8s在集群中实现期望状态</li> <li>k8s启动循环监听, 保证当前状态符合期望状态</li></ol> <blockquote><p>循环监听会有很多个, 有监听副本数量的, 有监听存储卷挂载的, 下面会有讲解.</p></blockquote> <h2 id="pod"><a href="#pod" class="header-anchor">#</a> Pod</h2> <p><img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-pod.png" alt="k8s-pod">
pod是k8s调度的原子单位, 就像容器是docker调度的原子单位一样.</p> <p>k8s是无法直接运行容器的, 它使用pod来对容器进行一层简单的封装, 以允许容器运行在k8s中. pod就是为用户在宿主机系统中划出一部分区域, 构建一个网络栈, 创建一组内核命名空间, 并且在其中运行一个或多个容器.</p> <p>pod中可以包含一个或多个容器, 或者说pod是被一个或多个容器共享的执行环境. 比如我们可以一个pod包含一个微服务,
也可以在一个pod中同时包含微服务与其依赖的基础设施服务(打比方, 通常不会这么做). <strong>注意是包含不是运行</strong></p> <p>pod的部署是原子操作, 只有pod中的容器都启动成功运行后, pod提供的服务才被认为可用.</p> <p>由于pod运行中可能会出现意外销毁, 而k8s的自愈功能会启动一个新pod来取到原pod(pod本身没有这个能力, Deployment才有). 新的pod会有<strong>新的id与新的ip</strong>, 所以我们<strong>切记不要在程序中去
依赖某个特定的pod</strong></p> <h3 id="manifest"><a href="#manifest" class="header-anchor">#</a> manifest</h3> <p>在声明式模型中提到我们可以使用manifest文件的方式去告诉k8s部署一个什么样的应用, 下面简单配置一个manifest.</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>pod
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">zone</span><span class="token punctuation">:</span> prod
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nigelpoulton/k8sbook<span class="token punctuation">:</span>latest
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>apiVersion: 创建部署对象的API组合API版本. 值得格式应该是&lt;api-group&gt;-&lt;version&gt;. 在k8s的manifest文件中, apiGroup可以省略不写, 默认是core. 也就是<code>apiVersion:V1</code>等价于
<code>apiVersion:core/v1</code></li> <li>kind: 通知k8s要部署的对象类型. kind的value是一个枚举, 可选的值有<code>Namespace</code>, <code>Service</code>, <code>Pod</code>, <code>Deployment</code>, <code>PersistentVolume</code>等等. 这里写<code>Pod</code>, 表示要部署一个Pod对象.</li> <li>metadata: metadata中定义的信息用于在集群中识别被部署的对象. 这里定义Pod对象的名称为hello-pod. 同时为其赋予了两个标签<code>zone: prod</code>, <code>version: v1</code>. 以便与Service建立关联, 后续会讲到.</li> <li>spec: spec=special, spec中定义Pod对象中要运行的容器以及相关配置, 如挂载卷, 启动副本数量等等. 这里指定运行一个image为<code>nigelpoulton/k8sbook:latest</code>的容器, 暴露8080端口, 并取名为hello-ctr</li></ul> <h3 id="deploy"><a href="#deploy" class="header-anchor">#</a> deploy</h3> <p>在编写完manifest文件后. 我们需要将这个文件提交给k8s去让他运行把Pod副本到可以工作的节点上去. 下面是会涉及到的一些kubectl与API Server交互的一些命令.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># POST manifest文件到API Serve</span>
F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>pods<span class="token operator">&gt;</span>kubectl apply <span class="token parameter variable">-f</span> pod.yml  
pod/hello-pod created

<span class="token comment"># 查看部署的pod</span>
F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>pods<span class="token operator">&gt;</span>kubectl get pods
NAME        READY   STATUS    RESTARTS   AGE
hello-pod   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          66s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>当看到pod的状态为Running时, 代表pod已经在k8s中运行了. 我们可以使用<code>kubectl exec</code>命令进入pod操作, 也可以使用<code>kubectl logs</code>命令查看pod的日志. 这一点与docker大同小异. 不再赘述.</p> <p>上面用到的<code>kubectl apply -f</code>命令是通用的k8s的manifest文件部署启动命令, 除了启动Pod以外, 启动后面会讲到的所有的k8s对象的manifest文件也都是通过这个命令来部署.</p> <p>还有<code>kubectl get</code>命令也是通用. <code>kubectl describe</code>命令则可以更详细的查看k8s对象的信息.</p> <h2 id="deployment"><a href="#deployment" class="header-anchor">#</a> Deployment</h2> <p>Pod对象本身是没有故障自愈, 滚动升级等能力的. 所以Pod的部署一般是通过更上层的Deployment来完成的. 它是对Pod的更进一步的封装, 提供了扩缩容管理, 不停机更新和版本控制功能.</p> <p><strong>一个Deployment对象只能管理一个Pod模版</strong>, 如果有多个Pod对象, 那么每个Pod对象都应该有自己的Deployment</p> <p>Deployment的内部使用ReplicaSet对象来完成Pod的自愈, 滚动升级等, 他是声明式模型(期望状态)实现的关键, 它实现了监视循环.</p> <p>当滚动升级的时候, Deployment会保留原来的ReplicaSet对象的情况下, 启动一个新的ReplicaSet对象来启动新的Pod副本, 如果需要回滚, 只需要停止新的ReplicaSet, 然后启动旧ReplicaSet就可以了.</p> <p><img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-replicaSet.png" alt="k8s-replicaSet"></p> <h3 id="manifest-2"><a href="#manifest-2" class="header-anchor">#</a> manifest</h3> <p>下面定义一个deploy.yml文件来通过Deployment对象启动一组pod对象</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>deploy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>pod
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nigelpoulton/k8sbook<span class="token punctuation">:</span>latest
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>apiVersion与kind和metadata属性不再赘述. 都是k8s对象manifest的通用属性. 这里只解释spec中的信息含义</p> <ul><li>replicas: 表示要部署多少pod副本</li> <li>selector: 表示这个Deployment对象下所管理的Pod副本需要具备哪些标签.</li> <li>minReadySeconds: 这个属性表示在逐个更新Pod时, 每个Pod更新间隔的时间是多少, 定义这个属性可以避免一次性全部更新Pod时出现问题而不易追踪问题</li> <li>strategy: 表示使用滚动更新的策略, 下面的<code>maxUnavailable</code>和<code>maxSurge</code>参数表示滚动更新Pod时, 不能出现比期望状态多出一个以上或少一个以上pod的情况. 结合<code>replicas: 10</code>来说就是滚动更新时运行中的pod不能少于9个也不能多于11个.</li> <li>template: 这里定义的是Deployment对象所管理的Pod的具体属性, 参考Pod.yml</li></ul> <h3 id="deploy-2"><a href="#deploy-2" class="header-anchor">#</a> deploy</h3> <p>使用如下命令来提交一个Deployment:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># POST manifest文件到API Server</span>
F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl apply <span class="token parameter variable">-f</span> deploy.yml
deployment.apps/hello-deploy created

<span class="token comment"># READY列中为已启动数量/预期启动数量</span>
F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl get deploy
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
hello-deploy   <span class="token number">4</span>/10    <span class="token number">10</span>           <span class="token number">0</span>           11s

<span class="token comment"># 所有pod副本启动完毕</span>
F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
hello-deploy-65cbc9474c-2qmkz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-669rg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-9nzp7   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-f9hhd   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-gknps   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-lq9cz   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-m6r2l   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-mfgqx   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-pc7tg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
hello-deploy-65cbc9474c-r8ztb   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          58s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="rollingupdate"><a href="#rollingupdate" class="header-anchor">#</a> RollingUpdate</h3> <p>当修改manifest文件后再次执行apply命令提交. 然后使用<code>kubectl rollout status</code>命令查看更新过程</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl rollout status deployment hello-deploy
Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;hello-deploy&quot;</span> rollout to finish: <span class="token number">4</span> of <span class="token number">10</span> updated replicas are available<span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;hello-deploy&quot;</span> rollout to finish: <span class="token number">9</span> of <span class="token number">10</span> updated replicas are available<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="rollback"><a href="#rollback" class="header-anchor">#</a> Rollback</h3> <p>执行回滚操作需要一个deploy的版本号. 这个版本号可以在执行apply命令时通过<code>--record</code>参数记录下来. 然后通过一下命令查看历史版本号</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl rollout <span class="token function">history</span> deployment hello-deploy
deployment.apps/hello-deploy
REVISION  CHANGE-CAUSE
<span class="token number">1</span>         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
<span class="token number">2</span>         kubectl apply <span class="token parameter variable">--filename</span><span class="token operator">=</span>deploy.yml <span class="token parameter variable">--record</span><span class="token operator">=</span>true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为我们已经执行过了一次滚动升级, 所以hello-deploy对象中现在应该有两个ReplicaSet对象</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl get rs
NAME                      DESIRED   CURRENT   READY   AGE
hello-deploy-65cbc9474c   <span class="token number">0</span>         <span class="token number">0</span>         <span class="token number">0</span>       16m
hello-deploy-6f797c4b74   <span class="token number">10</span>        <span class="token number">10</span>        <span class="token number">10</span>      3m15s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到更早创建的hello-deploy-65cbc9474c中Pod副本数量已经为零, 新创建的hello-deploy-6f797c4b74中Pod数量为10.</p> <p>现在通过undo命令回滚版本</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl rollout undo deployment hello-deploy --to-revision<span class="token operator">=</span><span class="token number">1</span>
deployment.apps/hello-deploy rolled back
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>再次查看ReplicaSet对象, 旧的ReplicaSet中的Pod对象已经开始逐个启动, 新的ReplicaSet中的Pod对象开始逐个销毁</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>deployments<span class="token operator">&gt;</span>kubectl get rs
NAME                      DESIRED   CURRENT   READY   AGE
hello-deploy-65cbc9474c   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">2</span>       20m
hello-deploy-6f797c4b74   <span class="token number">8</span>         <span class="token number">8</span>         <span class="token number">8</span>       6m59s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="service"><a href="#service" class="header-anchor">#</a> Service</h2> <p>由于Pod可能会出现扩缩容, 故障时替换的情况, 导致了Pod的IP地址变化. 因此Pod时不可靠的, 我们不能直接去依赖Pod. Service解决了这个问题, 它提供了稳定的网络.</p> <p><img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-service.png" alt="k8s-service">
我们可以把Service对象想象为具备前后两端. 前端有自己的DNS名称, IP和端口号; 后端有对Pod的动态负载均衡机制, 并且实现了自我监控, 可以自动更新.
<img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-servoce-selector.png" alt="k8s-service">
Service使用标签和标签选择器来决定将流量负载均衡到哪个Pod.</p> <h3 id="endpoint"><a href="#endpoint" class="header-anchor">#</a> Endpoint</h3> <p>Service在创建后都会得到一个关联的Endpoint对象, 这个对象是一个动态的列表, 包含了所有匹配Service Selector的健康Pod.</p> <p>当Service有流量需要转发时, 通过Endpoint对象中的Pod列表来查找Pod</p> <p>启动会Service后可以查看对应的Endpint对象</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>services<span class="token operator">&gt;</span>kubectl get ep hello-svc
NAME        ENDPOINTS                                                  AGE
hello-svc   <span class="token number">10.1</span>.0.37:8080,10.1.0.38:8080,10.1.0.39:8080 + <span class="token number">7</span> more<span class="token punctuation">..</span>.   9m21s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="type"><a href="#type" class="header-anchor">#</a> type</h3> <p>Service有多种类型, 不同类型的Service对应不同的外部访问策略</p> <ul><li><strong>ClusterIP</strong></li></ul> <p>ClusterIP类型的Service有固定的IP和端口号, <strong>只能从集群的内部访问</strong>.</p> <p>ClusterIP与Service名称一起被注册到集群内部的DNS服务中. 因为所有Pod都知道集群的DNS服务, 所以所有的Pod都能够解析Service名称. 之所以是内部访问是因为要访问集群的DNS才能够找到对应的IP,
所以ClusterIP类型的Service只对Pod和集群中的其他对象奏效.</p> <ul><li><strong>NodePort</strong></li></ul> <p>NodePort在ClusterIP的基础上增加了外部访问的能力.</p> <p>NodePort在集群的人与节点上都是相同的, 也就是从集群外部访问任一节点上的NodePort指定的端口号都可以找到Service, 即使这个节点上并没有Service及其选择器对应的Pod</p> <p>集群内部的Pod找到Service要通过名称, 而外部的则是通过NodePort.</p> <p>NodePort的端口范围在30000-32767之间</p> <ul><li><strong>LoadBalancer</strong></li></ul> <p>LoadBalancer同样能够在外部访问, 同时他还能够与云服务上提供的负载均衡服务集成. 他是基于NodePort实现的.</p> <ul><li><strong>ExternalName</strong></li></ul> <p>ExternalName能够将流量路由到k8s之外的系统</p> <h3 id="manifest-3"><a href="#manifest-3" class="header-anchor">#</a> manifest</h3> <p>前面的实例中已经通过Deployment部署了10个监听8080端口的Pod. 但是因为没有配置网络, 所以我们通过宿主机IP+8080并不能访问到内部的Pod. 正好可以通过NodePort Service的方式去接收流量.</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>svc
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> hello<span class="token punctuation">-</span>world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>metadata中的labels并不是用来筛选Pod的, 而是用来匹配Service的.</p> <p>spec中定义信息解释:</p> <ul><li>type: 表明service类型为NodePort, 可被集群外访问</li> <li>ports:
<ul><li>port: 指的是Service暴露在ClusterIP上的端口号. 这是提供给集群内部来使用的.</li> <li>nodePort: 对外监听30001端口, 也就是集群外部通过&lt;集群任意节点IP&gt;:30001就可以访问到这个Service对象</li> <li>targetPort: 当收到请求后, 将流量路由到Pod的8080端口上</li> <li>protocol: 使用TCP协议, 这也是默认的</li></ul></li> <li>selector: 上面ports中配置的流量路由策略会作用到标签含有app=hello-world的pod上</li></ul> <p>通过apply提交后访问http://127.0.0.1:30001
<img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-servoce-nodeport.png" alt="k8s-service-nodeport"></p> <p>使用logs命令可以查看这次流量被路由到了哪个节点</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>services<span class="token operator">&gt;</span>kubectl logs <span class="token parameter variable">-f</span> service/hello-svc
Found <span class="token number">10</span> pods, using pod/hello-deploy-65cbc9474c-77xx9
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="服务注册与服务发现"><a href="#服务注册与服务发现" class="header-anchor">#</a> 服务注册与服务发现</h2> <blockquote><p>填坑之前<a href="/microservice/contact.html#平台服务发现模式">微服务专栏</a>中提到的虚拟IP实现服务发现部分</p></blockquote> <h3 id="服务注册"><a href="#服务注册" class="header-anchor">#</a> 服务注册</h3> <p>k8s内部使用一个DNS服务作为服务注册中心, 他实际上是运行在kube-system命名空间中的一个名为coredns的由Deployment管理的一组Pod. 是k8s的原生应用.</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>services<span class="token operator">&gt;</span>kubectl get pods <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">-l</span> k8s-app<span class="token operator">=</span>kube-dns
NAME                      READY   STATUS    RESTARTS   AGE
coredns-f9fd979d6-9sg5x   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h3m
coredns-f9fd979d6-bpkhw   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h3m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol><li>POST Service的manifest文件到API Server</li> <li>Service被分配ClusterIP</li> <li>配置持久化到集群存储</li> <li>Endpoint对象被创建</li> <li>集群的DNS发现新的Service</li></ol> <blockquote><p>DNS内部有一个Controller会监听API Server</p></blockquote> <ol start="6"><li>创建新的DNS记录</li> <li>每个节点上的kube proxy拉取Service配置</li> <li>创建IPVS规则</li></ol> <blockquote><p>每个节点的kubelet进程都会监视Endpoint对象的创建</p></blockquote> <h3 id="服务发现"><a href="#服务发现" class="header-anchor">#</a> 服务发现</h3> <p>k8s会自动配置所有容器, 让他们能够找到集群的DNS, 并用来将Service名字解析为ClusterIP. 实际操作是k8s为每个容器都注入了一个/etc/resolv.conf.</p> <ol><li>通过DNS解析到Service对应的ClusterIP</li> <li>将流量发送到ClusterIP</li> <li>但是没有路由, 将流量发送到容器的默认网关</li></ol> <blockquote><p>因为这个ClusterIP是在一个特殊的名为servicenetwork的网络上, 是没有路由可达的, 所以容器不知道该把流量发到哪, 只能发送到默认网关.</p></blockquote> <ol start="4"><li>转发到集群节点</li> <li>集群节点也没有路由, 在转发到节点的默认网关</li></ol> <blockquote><p>由于主机节点同样没有servicenetwork的路由, 所以只能再发往自身的默认网关.</p></blockquote> <ol start="6"><li>流量被节点内核处理</li> <li>流量被IPVS规则捕获</li> <li>将流量发往的目标IP重写为Pod的IP</li></ol> <h3 id="故障排查"><a href="#故障排查" class="header-anchor">#</a> 故障排查</h3> <p>由于k8s使用集群内置DNS服务作为服务的注册中心使用, 所以如果有服务注册发现相关的问题应该先排查这里.</p> <p>集群的DNS是一组运行在kube-system命名空间中的pod和一个用来提供稳定网络入库的Service对象构成. 他主要包括三个组件:</p> <ul><li>pods: 由coredns Deployment管理</li> <li>Service: 一个名为kube-dns的ClusterIP Service, 监听TCP/UDP 53端口</li> <li>Endpoint: 也叫kube-dns</li></ul> <p>所有与集群DNS相关的对象都有一个k8s-app=kube-dns的标签. 这个需要记住. 方便命令排查.</p> <p>针对DNS的排查过程如下:</p> <ol><li>先确定coredns Deployment及其管理的pods运行状态.</li> <li>查看coredns的每个pod的日志</li> <li>查看Service是否在运行中, 且监听端口是53, 且有ClusterIP</li> <li>查看Endpoint对象是否正在运行且拥有所有coredns pod的IP地址</li></ol> <p>当DNS排查没有问题后, 可以再通过启动一个单例的名为dnsutils的pod来排查. 这个pod中内置了一些常用的网络工具如ping, curl, nslookup.</p> <h2 id="存储"><a href="#存储" class="header-anchor">#</a> 存储</h2> <p>k8s的存储与docker的存储不一样, 它要复杂的多, pod将资源挂载到外部存储需要很多个步骤, 不过也正因如此, k8s对存储的控制也更灵活多变.</p> <p>k8s的存储分为三部分: <strong>持久化卷子系统, 插件, 存储提供者</strong>.</p> <p><img src="https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-storage.png" alt="k8s-storage"></p> <p>pod对象通过持久化卷子系统来完成数据与外部存储的挂载. 而k8s的持久化卷子系统通过插件层访问存储提供者.</p> <p>持久化卷中有三个主要的组件: <strong>PV: 持久化卷, PVC: 持久化卷的访问许可, CS: 存储类</strong>.</p> <h3 id="volume"><a href="#volume" class="header-anchor">#</a> Volume</h3> <p>k8s为不同的部署环境, 使用需求提供了支持非常多的卷类型. 主要分为两类: 节点宿主机存储与节点外存储.</p> <p>节点外存储有<code>awsElasticBlockStore(亚马逊ES卷存储)</code>, <code>azureDisk(微软Azure)</code>等等等等.</p> <p>节点宿主机存储如<code>hostPath</code>, <code>local</code>则是将节点宿主机的文件系统上的文件或目录挂载到使用这个卷的Pod中.</p> <p>卷不能挂载到其他卷之上, 也不能与其他卷有硬连接. Pod配置中的每个容器都必须独立指定各个卷的挂在位置.</p> <h4 id="manifest-4"><a href="#manifest-4" class="header-anchor">#</a> manifest</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pd
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;3000&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /test<span class="token punctuation">-</span>pd
          <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>volume
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>volume
      <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
        <span class="token comment"># 宿主上目录位置</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>在这个声明Pod的模版中的spec部分一并声明了一个hostPath的卷, 指定挂载到主机的/data目录下</p> <h3 id="persistent-volume"><a href="#persistent-volume" class="header-anchor">#</a> Persistent Volume</h3> <p>k8s中的PV对象不像docker, 它可以绑定本地磁盘以及其他外部存储, 他定义了集群的存储采用什么介质.</p> <p>一个外部存储只能被一个PV使用, 一个PV可以被多个POD访问, 但是要定义规则来确保正常访问, 同时Pod不能直接访问PV, 必须经过PVC.PV对象可以通过PVC对Pod实现共享.</p> <p><strong>PV</strong>有三种访问模式:</p> <ul><li>ReadWriteOnce: 限制一个PV只能以读写方式绑定到一个PVC上, 如果尝试绑定到多个PVC将会失败.</li> <li>ReadWriteMany: 允许一个PV以读写方式挂载到多个PVC上, 这种模式只支持NFS这样的文件或对象存储.</li> <li>ReadOnlyMany: 允许以只读方式挂载到多个PVC上</li></ul> <p>PV的核心是一个目录, 其中可能存有数据, Pod中的容器可以访问这个目录中的数据, 所采用的特定的卷类型将决定目录如何形成, 使用何种介质保存数据以及目录中存放的内容.</p> <p>PV可以事先通过manifest文件提供, 也可以通过SC动态创建. 他的生命周期独立于使用它的Pod.</p> <h4 id="manifest-5"><a href="#manifest-5" class="header-anchor">#</a> manifest</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pv
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> local
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> manual
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这个文件的声明含义是挂载主机的/data目录上, 并且只占用10G存储空间; 除此之外, 对PVC允许的访问模式是ReadWriteOnce. storageClassName指定为manual. 后面的SC部分会将.</p> <h3 id="pvc"><a href="#pvc" class="header-anchor">#</a> PVC</h3> <p>Persistent Volume Claim表达的是Pod对PV的使用请求. 概念与Pod相似. Pod会占用节点的资源, 而PVC<strong>申领</strong>会占用PV的资源. Pod可以请求特定数量的资源如CPU和内存. PVC申领也可以请求特定的大小和访问模式.</p> <p>当pod通过PVC访问PV时, 可以选择将PV中的某个目录挂载到pod中的容器目录上.</p> <p>当不再使用PV时, 我们可以通知API Server将PVC删除, 来回收再利用资源. PVC有三种回收策略来告诉集群, 当PV从申领中释放时应该如何处理这个数据卷.</p> <ul><li><strong>Retain</strong>: 保留PV对象以及外部存储中的资源, 但是这回导致其他PVC无法继续使用这个PV. 如果要重复使用这个PV占用的存储, 可以手动删除PV对象. PV对象绑定的外部存储中的数据是会保留的.</li> <li><strong>Delete</strong>: 删除PVC时, 同时将PV以及PV在外部存储中的资源删除. 这是<strong>默认</strong>的.</li></ul> <h4 id="manifest-6"><a href="#manifest-6" class="header-anchor">#</a> manifest</h4> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> manual
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 3Gi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这个文件的含义是PVC申领storageClassName为manual的PV对象大小为3G的存储空间. 这里spec.storageClassName要与PV的manifest中的spec.storageClassName相对应.</p> <p>accessModes声明为rwo, 将会去寻找相同storageClassName下的支持row访问模式的PV对象.</p> <p>在执行apply提交后, 控制平面将会查找有相同storageClassName的且满足申领要求的PV对象, 如果找的到, 则绑定到那个PV对象上. 否则将会一直处于Pending状态</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>storage<span class="token operator">&gt;</span>kubectl get pvc
NAME            STATUS   VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE
test-pv-claim   Bound    test-pv   10Gi       RWO            manual         2s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Pod使用PVC:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> task<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>storage
      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>container
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3000&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/test-vol&quot;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>storage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>spec.volumes中不再使用hostPath. 使用persistentVolumeClaim去指定要使用的PVC.</p> <h3 id="sc"><a href="#sc" class="header-anchor">#</a> SC</h3> <p>在大规模集群中, 手动创建大量PV和PVC是非常烦琐的. 这时可以使用StorageClass来动态分配. SC可以让我们不用手动创建PV, 只需要创建一个SC对象, 然后使用一个插件与
具体的某个存储后端联系起来.</p> <p>SC创建后会观察API Server上是否有新的被关联的PVC对象, 如果匹配的PVC出现, SC会自动在后端存储系统上创建所需要的卷,以及在k8s上创建PV.</p> <p>SC还有一个重要的作用是减少PVC对PV的详细信息的依赖.</p> <h4 id="manifest-7"><a href="#manifest-7" class="header-anchor">#</a> manifest</h4> <p>还是在本地测试一下</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> kubernetes.io/no<span class="token punctuation">-</span>provisioner
<span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> WaitForFirstConsumer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在定义SC的manifest时注意apiVersion为<code>storage.k8s.io/v1</code></p> <ul><li>provisioner: 表示不使用外部存储, 采用本地存储</li> <li>volumeBindingMode: 表示延迟绑定. PVC与PV的绑定被延迟到Pod的第一次调度时.</li></ul> <p>SC对象是不可变得, 在部署之后不可以再修改.</p> <p>定义一个PVC对象供Pod使用</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv<span class="token punctuation">-</span>ticket
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>部署之后查看PVC状态处于Pending, 也就是等待绑定的状态.</p> <p>再启动一个Pod的使用PVC</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> class<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pv<span class="token punctuation">-</span>ticket
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>ctr
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">:</span>latest
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> /bin/bash
    <span class="token punctuation">-</span> <span class="token string">&quot;-c&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;sleep 60m&quot;</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
      <span class="token key atrule">name</span><span class="token punctuation">:</span> data
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>发现启动报错</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>  Type     Reason            Age    From               Message
  ----     ------            ----   ----               -------
  Warning  FailedScheduling  10m    default-scheduler  <span class="token number">0</span>/1 nodes are available: <span class="token number">1</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> didn<span class="token string">'t find available persistent volumes to bind.
  Warning  FailedScheduling  10m    default-scheduler  0/1 nodes are available: 1 node(s) didn'</span>t <span class="token function">find</span> available persistent volumes to bind.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这是因为本地卷还不支持动态制备. 所以我们要先提供一个PV.</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage<span class="token punctuation">-</span>pv
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> local
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>storage
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>再次查看Pod状态已经运行成功.</p> <blockquote><p>更多的StorageClass  https://kubernetes.io/zh/docs/concepts/storage/storage-classes/</p></blockquote> <h2 id="configmap"><a href="#configmap" class="header-anchor">#</a> ConfigMap</h2> <p>ConfigMap对象将配置数据从Pod中剥离出来. 并可以动态的在Pod运行时注入数据.</p> <h3 id="创建方式"><a href="#创建方式" class="header-anchor">#</a> 创建方式</h3> <ul><li><strong>命令式</strong>:</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>storage<span class="token operator">&gt;</span>kubectl create configmap profile --from-literal <span class="token assign-left variable">name</span><span class="token operator">=</span>杨同港 --from-literal <span class="token assign-left variable">wx</span><span class="token operator">=</span>ytg2097
configmap/profile created


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><strong>声明式</strong>:</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>storage<span class="token operator">&gt;</span>kubectl create cm profile-json --from-file<span class="token operator">=</span>profile.json
configmap/profile-json created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;姓名&quot;</span><span class="token operator">:</span> <span class="token string">&quot;杨同港&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;微信号&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ytg2097&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="注入方式"><a href="#注入方式" class="header-anchor">#</a> 注入方式</h3> <ul><li><strong>环境变量</strong>:</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">chapter</span><span class="token punctuation">:</span> configmaps
  <span class="token key atrule">name</span><span class="token punctuation">:</span> envpod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ctr1
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>  <span class="token string">&quot;sleep&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;300&quot;</span> <span class="token punctuation">]</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WX
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> profile
              <span class="token key atrule">key</span><span class="token punctuation">:</span> wx
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> profile
              <span class="token key atrule">key</span><span class="token punctuation">:</span> name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>查看环境变量</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>configmaps<span class="token operator">&gt;</span>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> envpod <span class="token function">sh</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
/ <span class="token comment"># echo name:$NAME  wx: $WX</span>
name:Ashin wx: Ashin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><strong>容器启动命令参数</strong>:</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">chapter</span><span class="token punctuation">:</span> configmaps
  <span class="token key atrule">name</span><span class="token punctuation">:</span> envpod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ctr1
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo 博客作者: $(NAME) 微信号 $(WX) 济南的爷就是爷, 除了吃就是玩, 没别哒!&quot;</span> <span class="token punctuation">]</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WX
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> profile
              <span class="token key atrule">key</span><span class="token punctuation">:</span> wx
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NAME
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> profile
              <span class="token key atrule">key</span><span class="token punctuation">:</span> name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>configmaps<span class="token operator">&gt;</span>kubectl apply <span class="token parameter variable">-f</span> envpod.yml
pod/envpod created

F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>configmaps<span class="token operator">&gt;</span>kubectl logs <span class="token parameter variable">-f</span> envpod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><strong>某个卷上的文件</strong>:
这个很好理解. 我们使用卷挂载方式访问数据无非是将应用运行时产生数据保存. 和应用运行时读取两种用途.</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cmvol
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volmap
      <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> profile
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ctr
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> volmap
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-bash line-numbers-mode"><pre class="language-bash"><code>F:<span class="token punctuation">\</span>学习<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>TheK8sBook<span class="token punctuation">\</span>configmaps<span class="token operator">&gt;</span>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> cmvol <span class="token function">ls</span> /etc/name
kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed <span class="token keyword">in</span> a future version. Use kubectl <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> -- <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead.
name  wx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="statefulset"><a href="#statefulset" class="header-anchor">#</a> StatefulSet</h2> <p>StatefulSet也是k8s中的一等公民, 与Deployment的具备相同的能力, 可以管理Pod, 进行动态扩缩容, 故障自愈, 滚动升级.</p> <h3 id="不同点"><a href="#不同点" class="header-anchor">#</a> 不同点</h3> <ul><li><strong>Pod名字可预知且保持不变</strong>
原因是StatefulSet启动Pod是有顺序的, Pod的命名是&lt;StatefulSet名称&gt;-&lt;1&gt;,&lt;StatefulSet名称&gt;-&lt;2&gt;,&lt;StatefulSet名称&gt;-&lt;n&gt;</li> <li><strong>DNS主机名可预知保持不变</strong>
DNS的主机名就是StatefulSet的名称</li> <li><strong>卷绑定可预知保持不变</strong></li></ul> <p>以上三个特性在哪些要求Pod保持不变的应用中非常有用.</p> <h3 id="headlessservice"><a href="#headlessservice" class="header-anchor">#</a> headlessService</h3> <p>由StatefulSet部署的Pod是可预知的. 所以我们的一些应用可能会直接连接到某个Pod上去. 为了实现这一功能, k8s提供了一个特殊的Service对象headlessService来为StatefulSet使用headlessService来为StatefulSet中的每个Pod副本创建一个可预知的DNS主机名.</p> <p>headlessService是一个将spec.clusterIP设置为None的Service对象. 当这个headlessService设置为StatefulSet的<code>spec.service.Name</code>时就成为了StatefulSet的governingService.</p> <h3 id="volumeclaimtemplate"><a href="#volumeclaimtemplate" class="header-anchor">#</a> volumeClaimTemplate</h3> <p>在使用StatefulSet时, 如果没有Pod有独立存储的需求时, 可以使用volumeClaimTemplates.</p> <p>volumeClaimTemplate在每次创建一个新的Pod副本时, 会自动创建一个PVC, 还会自动为PVC命名, 用来准确关联Pod, PVC名为&lt;volumeClaimTemplate名称&gt;-&lt;Pod名&gt;</p> <blockquote><p>更多内容见官方文档  https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/</p></blockquote> <div class="custom-block warning"><p class="title">注意</p><p>在删除StatefulSet之前最好先缩容Pod副本数量到0来保证本地缓存安全落库</p></div></div></section> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/NiceAshin/edit/master/my_blog/cloud-native/k8s/k8s.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2/27/2026, 7:33:24 AM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/cloud-native/k8s/k8s-cluster.html">
          安装k8s集群
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#节点" class="sidebar-link reco-side-节点" data-v-b57cc07c>节点</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#主节点" class="sidebar-link reco-side-主节点" data-v-b57cc07c>主节点</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#工作节点" class="sidebar-link reco-side-工作节点" data-v-b57cc07c>工作节点</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#dns-网络" class="sidebar-link reco-side-dns-网络" data-v-b57cc07c>DNS/网络</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#声明式模型" class="sidebar-link reco-side-声明式模型" data-v-b57cc07c>声明式模型</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#pod" class="sidebar-link reco-side-pod" data-v-b57cc07c>Pod</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#manifest" class="sidebar-link reco-side-manifest" data-v-b57cc07c>manifest</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#deploy" class="sidebar-link reco-side-deploy" data-v-b57cc07c>deploy</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#deployment" class="sidebar-link reco-side-deployment" data-v-b57cc07c>Deployment</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#manifest-2" class="sidebar-link reco-side-manifest-2" data-v-b57cc07c>manifest</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#deploy-2" class="sidebar-link reco-side-deploy-2" data-v-b57cc07c>deploy</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#rollingupdate" class="sidebar-link reco-side-rollingupdate" data-v-b57cc07c>RollingUpdate</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#rollback" class="sidebar-link reco-side-rollback" data-v-b57cc07c>Rollback</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#service" class="sidebar-link reco-side-service" data-v-b57cc07c>Service</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#endpoint" class="sidebar-link reco-side-endpoint" data-v-b57cc07c>Endpoint</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#type" class="sidebar-link reco-side-type" data-v-b57cc07c>type</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#manifest-3" class="sidebar-link reco-side-manifest-3" data-v-b57cc07c>manifest</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#服务注册与服务发现" class="sidebar-link reco-side-服务注册与服务发现" data-v-b57cc07c>服务注册与服务发现</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#服务注册" class="sidebar-link reco-side-服务注册" data-v-b57cc07c>服务注册</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#服务发现" class="sidebar-link reco-side-服务发现" data-v-b57cc07c>服务发现</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#故障排查" class="sidebar-link reco-side-故障排查" data-v-b57cc07c>故障排查</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#存储" class="sidebar-link reco-side-存储" data-v-b57cc07c>存储</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#volume" class="sidebar-link reco-side-volume" data-v-b57cc07c>Volume</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#persistent-volume" class="sidebar-link reco-side-persistent-volume" data-v-b57cc07c>Persistent Volume</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#pvc" class="sidebar-link reco-side-pvc" data-v-b57cc07c>PVC</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#sc" class="sidebar-link reco-side-sc" data-v-b57cc07c>SC</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#configmap" class="sidebar-link reco-side-configmap" data-v-b57cc07c>ConfigMap</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#创建方式" class="sidebar-link reco-side-创建方式" data-v-b57cc07c>创建方式</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#注入方式" class="sidebar-link reco-side-注入方式" data-v-b57cc07c>注入方式</a></li><li class="level-2" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#statefulset" class="sidebar-link reco-side-statefulset" data-v-b57cc07c>StatefulSet</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#不同点" class="sidebar-link reco-side-不同点" data-v-b57cc07c>不同点</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#headlessservice" class="sidebar-link reco-side-headlessservice" data-v-b57cc07c>headlessService</a></li><li class="level-3" data-v-b57cc07c><a href="/cloud-native/k8s/k8s.html#volumeclaimtemplate" class="sidebar-link reco-side-volumeclaimtemplate" data-v-b57cc07c>volumeClaimTemplate</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.bb57ff9a.js" defer></script><script src="/assets/js/3.a30b6709.js" defer></script><script src="/assets/js/1.cca03dd0.js" defer></script><script src="/assets/js/23.a13fd506.js" defer></script>
  </body>
</html>
