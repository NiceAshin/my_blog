(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{437:function(s,t,a){"use strict";a.r(t);var e=a(2),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kubernetes-ingress-实战详解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-ingress-实战详解"}},[s._v("#")]),s._v(" Kubernetes Ingress 实战详解")]),s._v(" "),t("blockquote",[t("p",[s._v("预计阅读时间：9 分钟")])]),s._v(" "),t("h2",{attrs:{id:"_1-来源与演进"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-来源与演进"}},[s._v("#")]),s._v(" 1. 来源与演进")]),s._v(" "),t("p",[s._v("本文整理自 Kubernetes 官方文档、Ingress-NGINX 与 Traefik 社区的最佳实践，以及我们在多租户 API 网关迁移中的案例。重点关注 1.19+ Ingress V1 API 与 Gateway API 的关系，帮助团队在云原生架构中构建统一的北向入口。")]),s._v(" "),t("h2",{attrs:{id:"_2-现状痛点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-现状痛点"}},[s._v("#")]),s._v(" 2. 现状痛点")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("传统负载均衡器成本高")]),s._v("：每个服务申请一个 SLB，费用与管理成本难以接受。")]),s._v(" "),t("li",[t("strong",[s._v("多租户路由混乱")]),s._v("：同一集群中多个团队共享 Ingress 控制器，却缺少规范导致冲突。")]),s._v(" "),t("li",[t("strong",[s._v("安全策略分散")]),s._v("：限流、WAF、证书续签各自为政，排查困难。")])]),s._v(" "),t("h2",{attrs:{id:"_3-ingress-核心概念回顾"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-ingress-核心概念回顾"}},[s._v("#")]),s._v(" 3. Ingress 核心概念回顾")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("Ingress 对象")]),s._v("：声明路由规则、域名、TLS 证书等。")]),s._v(" "),t("li",[t("strong",[s._v("Ingress Controller")]),s._v("：具体实现，如 Ingress-NGINX、Traefik、HAProxy、ALB Controller。")]),s._v(" "),t("li",[t("strong",[s._v("Service / EndpointSlice")]),s._v("：Ingress Controller 通过 Service 找到后端 Pod。")])]),s._v(" "),t("div",{staticClass:"language-mermaid line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-mermaid"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR\n    Client "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),t("span",{pre:!0,attrs:{class:"token label property"}},[s._v("|HTTPS|")]),s._v(" Ingress\n    Ingress "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),t("span",{pre:!0,attrs:{class:"token label property"}},[s._v("|Routes|")]),s._v(" Controller\n    Controller "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),t("span",{pre:!0,attrs:{class:"token label property"}},[s._v("|Proxy|")]),s._v(" Service\n    Service "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" Pod1\n    Service "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" Pod2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"_4-常见实现对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-常见实现对比"}},[s._v("#")]),s._v(" 4. 常见实现对比")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("控制器")]),s._v(" "),t("th",[s._v("优势")]),s._v(" "),t("th",[s._v("适用场景")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[t("strong",[s._v("Ingress-NGINX")])]),s._v(" "),t("td",[s._v("社区最广泛，特性成熟，支持自定义 Lua。")]),s._v(" "),t("td",[s._v("传统企业网关替换、需要细粒度配置")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("Traefik")])]),s._v(" "),t("td",[s._v("配置简单，内置 Let’s Encrypt，原生支持 HTTP/3。")]),s._v(" "),t("td",[s._v("快速交付、混合云环境")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("AWS ALB")])]),s._v(" "),t("td",[s._v("深度集成云平台，按需创建 ALB。")]),s._v(" "),t("td",[s._v("公有云重度用户")])]),s._v(" "),t("tr",[t("td",[t("strong",[s._v("Kong Ingress")])]),s._v(" "),t("td",[s._v("可扩展插件体系，支持认证、限流、日志。")]),s._v(" "),t("td",[s._v("需要 API 管理能力的团队")])])])]),s._v(" "),t("h2",{attrs:{id:"_5-关键配置详解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-关键配置详解"}},[s._v("#")]),s._v(" 5. 关键配置详解")]),s._v(" "),t("h3",{attrs:{id:"_5-1-基础路由"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-基础路由"}},[s._v("#")]),s._v(" 5.1 基础路由")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Ingress\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" loan"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("api\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nginx.ingress.kubernetes.io/rewrite-target")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ingressClassName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tls")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" api.loan.example.com\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" loan"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("api"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tls\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" api.loan.example.com\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /v1/credit\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pathType")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Prefix\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("backend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("service")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" credit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n                "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("number")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("h3",{attrs:{id:"_5-2-多租户隔离"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-多租户隔离"}},[s._v("#")]),s._v(" 5.2 多租户隔离")]),s._v(" "),t("ul",[t("li",[s._v("通过 "),t("code",[s._v("ingressClassName")]),s._v(" 将不同业务绑定到不同 Controller。")]),s._v(" "),t("li",[s._v("使用 "),t("code",[s._v("Namespace")]),s._v(" + "),t("code",[s._v("NetworkPolicy")]),s._v(" 限制访问面。")]),s._v(" "),t("li",[s._v("利用 "),t("code",[s._v("kubectl apply -f")]),s._v(" + GitOps 控制流，避免手动操作带来的冲突。")])]),s._v(" "),t("h3",{attrs:{id:"_5-3-安全强化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-安全强化"}},[s._v("#")]),s._v(" 5.3 安全强化")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("TLS 自动续签")]),s._v("：结合 cert-manager，配置 "),t("code",[s._v("ClusterIssuer")]),s._v("（ACME/企业 CA）。")]),s._v(" "),t("li",[t("strong",[s._v("WAF/限流")]),s._v("：Ingress-NGINX 提供 "),t("code",[s._v("limit-req")]),s._v("、"),t("code",[s._v("modsecurity")]),s._v("；Traefik 支持中间件链路。")]),s._v(" "),t("li",[t("strong",[s._v("零信任")]),s._v("：集成 OIDC 插件，实现基于用户身份的访问控制。")])]),s._v(" "),t("h2",{attrs:{id:"_6-与业务结合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-与业务结合"}},[s._v("#")]),s._v(" 6. 与业务结合")]),s._v(" "),t("p",[s._v("在支付网关迁移项目中：")]),s._v(" "),t("ol",[t("li",[s._v("统一入口域名 "),t("code",[s._v("pay.example.com")]),s._v("，根据路径将请求转发到 "),t("code",[s._v("order")]),s._v("、"),t("code",[s._v("settlement")]),s._v("、"),t("code",[s._v("notify")]),s._v(" 服务。")]),s._v(" "),t("li",[s._v("结合 Argo Rollouts 蓝绿发布，通过 Ingress 注解实现按百分比流量切换。")]),s._v(" "),t("li",[s._v("配置 "),t("code",[s._v("IngressRoute")]),s._v(" + "),t("code",[s._v("Middleware")]),s._v("，将合作方流量打上租户标签，并在 Prometheus 中监控成功率。")])]),s._v(" "),t("h2",{attrs:{id:"_7-进阶-向-gateway-api-演进"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-进阶-向-gateway-api-演进"}},[s._v("#")]),s._v(" 7. 进阶：向 Gateway API 演进")]),s._v(" "),t("ul",[t("li",[s._v("Gateway API 将 Listener、Route 拆分为更细粒度对象，便于平台团队与业务团队分权。")]),s._v(" "),t("li",[s._v("Ingress-NGINX 1.9+ 已支持 Gateway API Beta；可逐步引入 "),t("code",[s._v("GatewayClass")]),s._v(" 统一管理。")]),s._v(" "),t("li",[s._v("推荐组合：平台团队维护 "),t("code",[s._v("Gateway")]),s._v("，业务团队提交 "),t("code",[s._v("HTTPRoute")]),s._v("，实现 GitOps 合作。")])]),s._v(" "),t("h2",{attrs:{id:"_8-常见故障排查清单"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_8-常见故障排查清单"}},[s._v("#")]),s._v(" 8. 常见故障排查清单")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("kubectl describe ingress")]),s._v(" 查看事件，定位 404/503。")]),s._v(" "),t("li",[t("code",[s._v("kubectl logs deploy/ingress-nginx-controller")]),s._v(" 获取具体错误。")]),s._v(" "),t("li",[s._v("使用 "),t("code",[s._v('curl -H "Host: xxx" http://nodeip')]),s._v(" 模拟请求。")]),s._v(" "),t("li",[s._v("借助 "),t("code",[s._v("kail")]),s._v("、"),t("code",[s._v("stern")]),s._v(" 等工具实时跟踪日志。")])]),s._v(" "),t("h2",{attrs:{id:"_9-参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_9-参考资料"}},[s._v("#")]),s._v(" 9. 参考资料")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://kubernetes.io/docs/concepts/services-networking/ingress/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubernetes Ingress API Reference"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://kubernetes.github.io/ingress-nginx/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ingress-NGINX User Guide"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://gateway-api.sigs.k8s.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Gateway API 官网"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("通过标准化 Ingress 策略，可以在保证安全合规的同时，显著降低集群对外暴露成本，让业务团队专注于服务本身的演进。")])])}),[],!1,null,null,null);t.default=r.exports}}]);