(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{446:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"kubernetes-rbac-权限模型深度实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-rbac-权限模型深度实践"}},[t._v("#")]),t._v(" Kubernetes RBAC 权限模型深度实践")]),t._v(" "),s("blockquote",[s("p",[t._v("预计阅读时间：8 分钟")])]),t._v(" "),s("h2",{attrs:{id:"_1-资料来源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-资料来源"}},[t._v("#")]),t._v(" 1. 资料来源")]),t._v(" "),s("p",[t._v("基于 Kubernetes 官方安全指南、CIS Benchmark、阿里云/腾讯云托管集群最佳实践以及我们平台团队在打造多租户 DevOps 系统时的经验。")]),t._v(" "),s("h2",{attrs:{id:"_2-现状与问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-现状与问题"}},[t._v("#")]),t._v(" 2. 现状与问题")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("默认管理员权限泛滥")]),t._v("：为省事直接赋予 "),s("code",[t._v("cluster-admin")]),t._v("，留下审计风险。")]),t._v(" "),s("li",[s("strong",[t._v("角色定义混乱")]),t._v("：命名不统一、规则重叠，难以维护。")]),t._v(" "),s("li",[s("strong",[t._v("审计缺乏")]),t._v("：谁在什么时候执行了什么操作，没有可追溯记录。")])]),t._v(" "),s("h2",{attrs:{id:"_3-rbac-基础概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-rbac-基础概念"}},[t._v("#")]),t._v(" 3. RBAC 基础概念")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("Role/ClusterRole")]),t._v("：定义操作权限集合，作用域分别是命名空间级与集群级。")]),t._v(" "),s("li",[s("strong",[t._v("RoleBinding/ClusterRoleBinding")]),t._v("：将角色绑定至用户、组或 ServiceAccount。")]),t._v(" "),s("li",[s("strong",[t._v("ServiceAccount")]),t._v("：Pod 内部调用 Kubernetes API 的身份。")])]),t._v(" "),s("div",{staticClass:"language-mermaid line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-mermaid"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("graph")]),t._v(" LR\n    User"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("RoleBinding\n    ServiceAccount"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("RoleBinding\n    RoleBinding"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("Role\n    Role"),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v("Rules"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[API Group + Verb + Resource]")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h2",{attrs:{id:"_4-权限设计原则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-权限设计原则"}},[t._v("#")]),t._v(" 4. 权限设计原则")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("最小权限")]),t._v("：只授予完成任务所需的最小动作用例。")]),t._v(" "),s("li",[s("strong",[t._v("职责分离")]),t._v("：将开发、运维、安全人员权限拆分，避免单点权限过大。")]),t._v(" "),s("li",[s("strong",[t._v("可审计")]),t._v("：所有绑定通过代码管理，审计日志集中存储。")])]),t._v(" "),s("h2",{attrs:{id:"_5-实操示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-实操示例"}},[t._v("#")]),t._v(" 5. 实操示例")]),t._v(" "),s("h3",{attrs:{id:"_5-1-为业务团队创建命名空间角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-为业务团队创建命名空间角色"}},[t._v("#")]),t._v(" 5.1 为业务团队创建命名空间角色")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Role\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" loan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" loan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"services"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configmaps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secrets"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verbs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"list"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"watch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"create"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"patch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"delete"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deployments"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"statefulsets"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verbs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"list"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"watch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"create"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"patch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"delete"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RoleBinding\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" loan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("binding\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" loan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subjects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Group\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("team\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roleRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Role\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" loan"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br")])]),s("h3",{attrs:{id:"_5-2-serviceaccount-最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-serviceaccount-最佳实践"}},[t._v("#")]),t._v(" 5.2 ServiceAccount 最佳实践")]),t._v(" "),s("ul",[s("li",[t._v("每个 Deployment 单独创建 ServiceAccount，避免共享。")]),t._v(" "),s("li",[t._v("配合 "),s("code",[t._v("kubectl create token")]),t._v(" 或 "),s("code",[t._v("ProjectedServiceAccountToken")]),t._v("，限定有效期。")]),t._v(" "),s("li",[t._v("禁止在 Pod 中挂载默认 ServiceAccount，设置 "),s("code",[t._v("automountServiceAccountToken: false")]),t._v("。")])]),t._v(" "),s("h3",{attrs:{id:"_5-3-审计与合规"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-审计与合规"}},[t._v("#")]),t._v(" 5.3 审计与合规")]),t._v(" "),s("ul",[s("li",[t._v("开启 "),s("code",[t._v("apiserver")]),t._v(" Audit Log，输出到 Elasticsearch + Kibana。")]),t._v(" "),s("li",[t._v("使用 Kubewarden/Kyverno 设定策略，禁止申请 cluster-admin。")]),t._v(" "),s("li",[t._v("定期运行 "),s("code",[t._v("kubectl auth can-i")]),t._v(" 自动化测试权限。")])]),t._v(" "),s("h2",{attrs:{id:"_6-与业务结合"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-与业务结合"}},[t._v("#")]),t._v(" 6. 与业务结合")]),t._v(" "),s("p",[t._v("在多租户低代码平台中，我们：")]),t._v(" "),s("ul",[s("li",[t._v("为每个租户命名空间创建 "),s("code",[t._v("viewer")]),t._v("、"),s("code",[t._v("editor")]),t._v("、"),s("code",[t._v("ops")]),t._v(" 三种角色，对应不同操作。")]),t._v(" "),s("li",[t._v("提供自助式权限申请流程，审批通过后自动生成 RoleBinding。")]),t._v(" "),s("li",[t._v("集成企业 IAM，登录后根据用户组动态生成 kubeconfig。")])]),t._v(" "),s("h2",{attrs:{id:"_7-常见故障排查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-常见故障排查"}},[t._v("#")]),t._v(" 7. 常见故障排查")]),t._v(" "),s("ul",[s("li",[t._v("“Forbidden” 错误：使用 "),s("code",[t._v("kubectl auth can-i")]),t._v(" 检查用户是否具备权限。")]),t._v(" "),s("li",[t._v("ServiceAccount 无法访问资源：确认 RoleBinding 是否指向正确命名空间。")]),t._v(" "),s("li",[t._v("审计日志太大：使用 Fluent Bit 过滤，仅保留关键事件。")])]),t._v(" "),s("h2",{attrs:{id:"_8-延伸阅读"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-延伸阅读"}},[t._v("#")]),t._v(" 8. 延伸阅读")]),t._v(" "),s("ul",[s("li",[t._v("[CIS Kubernetes Benchmark]")]),t._v(" "),s("li",[s("a",{attrs:{href:"https://kubernetes.io/docs/reference/access-authn-authz/authorization/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Kubernetes Authorization Overview"),s("OutboundLink")],1)]),t._v(" "),s("li",[t._v("[Kyverno Policy Cookbook]")])]),t._v(" "),s("p",[t._v("合理设计 RBAC，是实现多租户、合规与安全运营的基础，为企业的云原生平台保驾护航。")])])}),[],!1,null,null,null);s.default=e.exports}}]);