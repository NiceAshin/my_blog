(window.webpackJsonp=window.webpackJsonp||[]).push([[124],{542:function(e,s,t){"use strict";t.r(s);var n=t(2),a=Object(n.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"记一次部署istio遇到的问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#记一次部署istio遇到的问题"}},[e._v("#")]),e._v(" 记一次部署Istio遇到的问题")]),e._v(" "),s("blockquote",[s("p",[e._v("预计阅读时间：7 分钟")])]),e._v(" "),s("p",[e._v("按照"),s("a",{attrs:{href:"https://istio.io/latest/zh/docs/setup/getting-started/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官方文档"),s("OutboundLink")],1),e._v("在虚拟机一主二从k8s环境中部署Istio时遇到**"),s("code",[e._v("Istiod encountered an error: failed to wait for resource: resources not ready after 5m0s: timed out waiting for the condition")]),e._v("**问题.")]),e._v(" "),s("p",[e._v("详细报错信息如下:")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("root@node1 deployment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# istioctl install --set profile=demo -y")]),e._v("\n✔ Istio core installed\nProcessing resources "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" Istiod. Waiting "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" Deployment/service-mesh-system/istiod                                                               \n✘ Istiod encountered an error: failed to "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("wait")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" resource: resources not ready after 5m0s: timed out waiting "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" the condition\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("先google得到以下解决方案")]),e._v(" "),s("p",[e._v("https://stackoverflow.com/questions/64373346/istioctl-install-fails-with-multiple-timeouts")]),e._v(" "),s("p",[e._v("将虚拟机内存从4g调整到16g. 再次执行"),s("code",[e._v("istioctl install")]),e._v("命令, 仍然报错, 问题未能解决.")]),e._v(" "),s("p",[e._v("后"),s("code",[e._v("kubectl get pods -n istio-system")]),e._v(" 查看istio的Pod的启动状态, 发现"),s("code",[e._v("istio-egressgateway")]),e._v("与 "),s("code",[e._v("istio-ingressgateway")]),e._v("两个pod全部处于"),s("code",[e._v("ContainerCreateing")]),e._v("状态. 长时间没有变化")]),e._v(" "),s("p",[e._v("而后describe查看Events一直在报错, Message中主要报错内容为: "),s("code",[e._v("stat /var/lib/calico/nodename: no such file or directory")])]),e._v(" "),s("p",[e._v("并且发现除了istio的pod之外, calico的pod也在报错.")]),e._v(" "),s("p",[e._v("然后查阅相关解决方案发现有人弃用calico该用flannel问题解决.  遂按步骤照做,  但是卡在了flannel安装的环节, 由于墙的原因, flannel安装失败.")]),e._v(" "),s("p",[e._v("再次装回calico.")]),e._v(" "),s("p",[e._v("再部署一个Deployment, 其中Pod副本为10, 发现还是报错"),s("code",[e._v("no such file or directory /var/lib/calico/nodename")]),e._v(".")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("root@node1 deployment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# kubectl get pods -A")]),e._v("\nNAMESPACE      NAME                                       READY   STATUS               RESTARTS   AGE\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\ndefault        hello-deploy-6f797c4b74-dr4cn              "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("/1     ContainerCreateing   "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v("          2m16s\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("p",[e._v("试图exec进入pod查看挂载点中nodename文件是否存在问题, 无法进入.   而后逐个查看各个宿主机中/var/lib/calico路径下文件是否存在.")]),e._v(" "),s("p",[e._v("发现node3机器中/var/lib/calico路径下无任何文件, 同时calico节点的tunl0网卡也不存在.  大致明确问题所在.")]),e._v(" "),s("p",[e._v("先将node3从集群中剥离:")]),e._v(" "),s("p",[e._v("master节点上执行:")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("kubectl drain node3 --delete-local-data\nkubectl delete "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("node")]),e._v(" node3\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("p",[e._v("然后node3节点上执行:")]),e._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[e._v("kubeadm reset\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("而后重新get pods发现之前一直卡在ContainerCreateing状态的pod已经恢复正常进入Running状态.")]),e._v(" "),s("p",[e._v("将node3重新加入节点执行kubeadm join.")]),e._v(" "),s("p",[e._v("集群恢复正常.  Istio安装成功")])])}),[],!1,null,null,null);s.default=a.exports}}]);