(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{432:function(s,a,t){"use strict";t.r(a);var n=t(2),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"k8s快速入门"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#k8s快速入门"}},[s._v("#")]),s._v(" k8s快速入门")]),s._v(" "),a("blockquote",[a("p",[s._v("本文为The kubernetes book的笔记. 作者Nigel Poulton, 译者"),a("a",{attrs:{href:"https://github.com/get-set",target:"_blank",rel:"noopener noreferrer"}},[s._v("刘康"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("K8s是一个应用编排器, 可以部署应用, 动态扩缩容, 故障自愈, 不停机回滚, 同时还是一个支撑应用运行的集群, 集群由一个或多个主节点和若干个工作节点构成. 集群内部的\nDNS服务还提供了服务发现与负载均衡的能力.")]),s._v(" "),a("p",[s._v("k8s与容器技术是互补的技术, 容器用于应用的开发. k8s用于应用编排.")]),s._v(" "),a("h2",{attrs:{id:"节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点"}},[s._v("#")]),s._v(" 节点")]),s._v(" "),a("p",[s._v("集群由一个或多个主节点和若干个工作节点构成. 其中主节点负责管理整个集群, 做调度决策, 监控集群, 响应事件的工作. 工作节点负责运行应用服务, 每个工作节点都有自己的主节点.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s.svg",alt:"k8s"}})]),s._v(" "),a("h3",{attrs:{id:"主节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#主节点"}},[s._v("#")]),s._v(" 主节点")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-master-node.png",alt:"master-node"}})]),s._v(" "),a("p",[s._v("k8s的主节点(或者说控制平面, 官方文档是这么称呼的)通常有一个或多个系统服务组成.  他为集群提供了故障转移和高可用性.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("API Server")])])]),s._v(" "),a("p",[s._v("k8s中所有的组件之间都通过API Server进行通信. API Server默认是一组RESTful风格的接口.")]),s._v(" "),a("p",[s._v("API Server位于控制平面的最前端, 所有的指令与通信都需要通过API Server来完成.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("集群存储")])])]),s._v(" "),a("p",[s._v("k8s默认使用etcd存储着整个集群的配置和状态, etcd更注重一致性.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Controller Manager")])])]),s._v(" "),a("p",[s._v("Controller用于确保集群的当前状态与预期状态相匹配. Controller有很多个, 比如终端Controller, 工作节点Controller, 副本Controller(一般指Pod副本). 每个Controller都在后台启动独立的\n循环监听功能.")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"},[s._v("循环监听逻辑")]),a("ol",[a("li",[s._v("获取期望状态")]),s._v(" "),a("li",[s._v("观察当前状态")]),s._v(" "),a("li",[s._v("对比状态")]),s._v(" "),a("li",[s._v("调整差异使当前状态去尽量符合期望状态")])])]),a("p",[s._v("Controller Manager负责创建Controller并监控他们的执行.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Scheduler")])])]),s._v(" "),a("p",[s._v("调度器监听API Server来启动新的工作任务, 并将其分配到合适的节点中, 合适与否由调度器判定. 判定条件有:节点是否存活, 任务依赖端口在节点中是否可用, 节点是否还有足够资源等等.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Cloud Controller Manager")])])]),s._v(" "),a("p",[s._v("如果集群运行在公有云平台, 控制平面会启动一个Cloud Controller Manager来负责集成底层的公有云服务. 如实例, 负载均衡等.")]),s._v(" "),a("h3",{attrs:{id:"工作节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工作节点"}},[s._v("#")]),s._v(" 工作节点")]),s._v(" "),a("p",[s._v("工作节点托管作为应用负载的Pod.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("kubelet")])])]),s._v(" "),a("p",[s._v("kubelet是工作节点的核心, 新的工作节点加入集群后, kubelet就会被部署到新节点上.")]),s._v(" "),a("p",[s._v("kubelet负责向集群汇报当前节点的资源状态, 如CPU, 内存等.")]),s._v(" "),a("p",[s._v("kubelet还会监听API Server分配的新任务, 每监听到一个就去执行这个任务, 并且与主节点维护一个通信频道, 当任务结束后返回执行结果.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Container Runtime")])])]),s._v(" "),a("p",[s._v("容器运行时供kubelet使用, 用于执行依赖容器的任务. 容器运行时可以由docker提供, 也可以由containerd或其他容器技术提供.")]),s._v(" "),a("blockquote",[a("p",[s._v("containerd是docker的精简版, 在某些时候更适合作为k8s的容器运行时.")])]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("kube-proxy")])])]),s._v(" "),a("p",[s._v("kube-proxy与kubelet和Container Runtime一样在每个工作节点中都存在, 它是维护节点上的网络规则, 允许从集群内部或外部与Pod进行网络通信.")]),s._v(" "),a("h2",{attrs:{id:"dns-网络"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dns-网络"}},[s._v("#")]),s._v(" DNS/网络")]),s._v(" "),a("p",[s._v("K8s有自己的DNS, 他有一个静态IP, 并且被硬编码在每个节点中. 他让我们可以使用一致的DNS名称而非IP地址来访问服务. 集群中的每个Service都会有一个DNS名称.")]),s._v(" "),a("h2",{attrs:{id:"声明式模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#声明式模型"}},[s._v("#")]),s._v(" 声明式模型")]),s._v(" "),a("p",[s._v("当我们要将一个应用运行在k8s上时, 通常需要先将应用打包为镜像, 然后封装到pod中去运行. 我们可以通过定义manifest文件(yml)的方式去部署.")]),s._v(" "),a("p",[s._v("我们在yml中告知k8s集群我们希望的应用运行状态. 也就是期望状态. 比如运行多少个副本. 然后提交到k8s中. k8s会确保应用的运行符合我们的期望状态.")]),s._v(" "),a("p",[s._v("整个流程如下:")]),s._v(" "),a("ol",[a("li",[s._v("在mainfest文件中声明一个应用的期望达到的状态")]),s._v(" "),a("li",[s._v("将manifest文件发送到API服务")]),s._v(" "),a("li",[s._v("k8s将manifest存储到集群存储中, 并作为应用的期望状态")]),s._v(" "),a("li",[s._v("k8s在集群中实现期望状态")]),s._v(" "),a("li",[s._v("k8s启动循环监听, 保证当前状态符合期望状态")])]),s._v(" "),a("blockquote",[a("p",[s._v("循环监听会有很多个, 有监听副本数量的, 有监听存储卷挂载的, 下面会有讲解.")])]),s._v(" "),a("h2",{attrs:{id:"pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pod"}},[s._v("#")]),s._v(" Pod")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-pod.png",alt:"k8s-pod"}}),s._v("\npod是k8s调度的原子单位, 就像容器是docker调度的原子单位一样.")]),s._v(" "),a("p",[s._v("k8s是无法直接运行容器的, 它使用pod来对容器进行一层简单的封装, 以允许容器运行在k8s中. pod就是为用户在宿主机系统中划出一部分区域, 构建一个网络栈, 创建一组内核命名空间, 并且在其中运行一个或多个容器.")]),s._v(" "),a("p",[s._v("pod中可以包含一个或多个容器, 或者说pod是被一个或多个容器共享的执行环境. 比如我们可以一个pod包含一个微服务,\n也可以在一个pod中同时包含微服务与其依赖的基础设施服务(打比方, 通常不会这么做). "),a("strong",[s._v("注意是包含不是运行")])]),s._v(" "),a("p",[s._v("pod的部署是原子操作, 只有pod中的容器都启动成功运行后, pod提供的服务才被认为可用.")]),s._v(" "),a("p",[s._v("由于pod运行中可能会出现意外销毁, 而k8s的自愈功能会启动一个新pod来取到原pod(pod本身没有这个能力, Deployment才有). 新的pod会有"),a("strong",[s._v("新的id与新的ip")]),s._v(", 所以我们"),a("strong",[s._v("切记不要在程序中去\n依赖某个特定的pod")])]),s._v(" "),a("h3",{attrs:{id:"manifest"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("p",[s._v("在声明式模型中提到我们可以使用manifest文件的方式去告诉k8s部署一个什么样的应用, 下面简单配置一个manifest.")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("zone")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prod\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ctr\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nigelpoulton/k8sbook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("ul",[a("li",[s._v("apiVersion: 创建部署对象的API组合API版本. 值得格式应该是<api-group>-<version>. 在k8s的manifest文件中, apiGroup可以省略不写, 默认是core. 也就是"),a("code",[s._v("apiVersion:V1")]),s._v("等价于\n"),a("code",[s._v("apiVersion:core/v1")])]),s._v(" "),a("li",[s._v("kind: 通知k8s要部署的对象类型. kind的value是一个枚举, 可选的值有"),a("code",[s._v("Namespace")]),s._v(", "),a("code",[s._v("Service")]),s._v(", "),a("code",[s._v("Pod")]),s._v(", "),a("code",[s._v("Deployment")]),s._v(", "),a("code",[s._v("PersistentVolume")]),s._v("等等. 这里写"),a("code",[s._v("Pod")]),s._v(", 表示要部署一个Pod对象.")]),s._v(" "),a("li",[s._v("metadata: metadata中定义的信息用于在集群中识别被部署的对象. 这里定义Pod对象的名称为hello-pod. 同时为其赋予了两个标签"),a("code",[s._v("zone: prod")]),s._v(", "),a("code",[s._v("version: v1")]),s._v(". 以便与Service建立关联, 后续会讲到.")]),s._v(" "),a("li",[s._v("spec: spec=special, spec中定义Pod对象中要运行的容器以及相关配置, 如挂载卷, 启动副本数量等等. 这里指定运行一个image为"),a("code",[s._v("nigelpoulton/k8sbook:latest")]),s._v("的容器, 暴露8080端口, 并取名为hello-ctr")])]),s._v(" "),a("h3",{attrs:{id:"deploy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy"}},[s._v("#")]),s._v(" deploy")]),s._v(" "),a("p",[s._v("在编写完manifest文件后. 我们需要将这个文件提交给k8s去让他运行把Pod副本到可以工作的节点上去. 下面是会涉及到的一些kubectl与API Server交互的一些命令.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# POST manifest文件到API Serve")]),s._v("\nF:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("pods"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" pod.yml  \npod/hello-pod created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看部署的pod")]),s._v("\nF:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("pods"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get pods\nNAME        READY   STATUS    RESTARTS   AGE\nhello-pod   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          66s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("当看到pod的状态为Running时, 代表pod已经在k8s中运行了. 我们可以使用"),a("code",[s._v("kubectl exec")]),s._v("命令进入pod操作, 也可以使用"),a("code",[s._v("kubectl logs")]),s._v("命令查看pod的日志. 这一点与docker大同小异. 不再赘述.")]),s._v(" "),a("p",[s._v("上面用到的"),a("code",[s._v("kubectl apply -f")]),s._v("命令是通用的k8s的manifest文件部署启动命令, 除了启动Pod以外, 启动后面会讲到的所有的k8s对象的manifest文件也都是通过这个命令来部署.")]),s._v(" "),a("p",[s._v("还有"),a("code",[s._v("kubectl get")]),s._v("命令也是通用. "),a("code",[s._v("kubectl describe")]),s._v("命令则可以更详细的查看k8s对象的信息.")]),s._v(" "),a("h2",{attrs:{id:"deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deployment"}},[s._v("#")]),s._v(" Deployment")]),s._v(" "),a("p",[s._v("Pod对象本身是没有故障自愈, 滚动升级等能力的. 所以Pod的部署一般是通过更上层的Deployment来完成的. 它是对Pod的更进一步的封装, 提供了扩缩容管理, 不停机更新和版本控制功能.")]),s._v(" "),a("p",[a("strong",[s._v("一个Deployment对象只能管理一个Pod模版")]),s._v(", 如果有多个Pod对象, 那么每个Pod对象都应该有自己的Deployment")]),s._v(" "),a("p",[s._v("Deployment的内部使用ReplicaSet对象来完成Pod的自愈, 滚动升级等, 他是声明式模型(期望状态)实现的关键, 它实现了监视循环.")]),s._v(" "),a("p",[s._v("当滚动升级的时候, Deployment会保留原来的ReplicaSet对象的情况下, 启动一个新的ReplicaSet对象来启动新的Pod副本, 如果需要回滚, 只需要停止新的ReplicaSet, 然后启动旧ReplicaSet就可以了.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-replicaSet.png",alt:"k8s-replicaSet"}})]),s._v(" "),a("h3",{attrs:{id:"manifest-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest-2"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("p",[s._v("下面定义一个deploy.yml文件来通过Deployment对象启动一组pod对象")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deploy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("world\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("minReadySeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RollingUpdate\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rollingUpdate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxUnavailable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxSurge")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("world\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nigelpoulton/k8sbook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br")])]),a("p",[s._v("apiVersion与kind和metadata属性不再赘述. 都是k8s对象manifest的通用属性. 这里只解释spec中的信息含义")]),s._v(" "),a("ul",[a("li",[s._v("replicas: 表示要部署多少pod副本")]),s._v(" "),a("li",[s._v("selector: 表示这个Deployment对象下所管理的Pod副本需要具备哪些标签.")]),s._v(" "),a("li",[s._v("minReadySeconds: 这个属性表示在逐个更新Pod时, 每个Pod更新间隔的时间是多少, 定义这个属性可以避免一次性全部更新Pod时出现问题而不易追踪问题")]),s._v(" "),a("li",[s._v("strategy: 表示使用滚动更新的策略, 下面的"),a("code",[s._v("maxUnavailable")]),s._v("和"),a("code",[s._v("maxSurge")]),s._v("参数表示滚动更新Pod时, 不能出现比期望状态多出一个以上或少一个以上pod的情况. 结合"),a("code",[s._v("replicas: 10")]),s._v("来说就是滚动更新时运行中的pod不能少于9个也不能多于11个.")]),s._v(" "),a("li",[s._v("template: 这里定义的是Deployment对象所管理的Pod的具体属性, 参考Pod.yml")])]),s._v(" "),a("h3",{attrs:{id:"deploy-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy-2"}},[s._v("#")]),s._v(" deploy")]),s._v(" "),a("p",[s._v("使用如下命令来提交一个Deployment:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# POST manifest文件到API Server")]),s._v("\nF:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy.yml\ndeployment.apps/hello-deploy created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# READY列中为已启动数量/预期启动数量")]),s._v("\nF:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get deploy\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nhello-deploy   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("/10    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("           11s\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有pod副本启动完毕")]),s._v("\nF:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nhello-deploy-65cbc9474c-2qmkz   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-669rg   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-9nzp7   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-f9hhd   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-gknps   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-lq9cz   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-m6r2l   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-mfgqx   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-pc7tg   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\nhello-deploy-65cbc9474c-r8ztb   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          58s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"rollingupdate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rollingupdate"}},[s._v("#")]),s._v(" RollingUpdate")]),s._v(" "),a("p",[s._v("当修改manifest文件后再次执行apply命令提交. 然后使用"),a("code",[s._v("kubectl rollout status")]),s._v("命令查看更新过程")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl rollout status deployment hello-deploy\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" deployment "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-deploy"')]),s._v(" rollout to finish: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" of "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" updated replicas are available"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nWaiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" deployment "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello-deploy"')]),s._v(" rollout to finish: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" of "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" updated replicas are available"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"rollback"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rollback"}},[s._v("#")]),s._v(" Rollback")]),s._v(" "),a("p",[s._v("执行回滚操作需要一个deploy的版本号. 这个版本号可以在执行apply命令时通过"),a("code",[s._v("--record")]),s._v("参数记录下来. 然后通过一下命令查看历史版本号")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl rollout "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment hello-deploy\ndeployment.apps/hello-deploy\nREVISION  CHANGE-CAUSE\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("         kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--filename")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("deploy.yml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--record")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("因为我们已经执行过了一次滚动升级, 所以hello-deploy对象中现在应该有两个ReplicaSet对象")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get rs\nNAME                      DESIRED   CURRENT   READY   AGE\nhello-deploy-65cbc9474c   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       16m\nhello-deploy-6f797c4b74   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("      3m15s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("可以看到更早创建的hello-deploy-65cbc9474c中Pod副本数量已经为零, 新创建的hello-deploy-6f797c4b74中Pod数量为10.")]),s._v(" "),a("p",[s._v("现在通过undo命令回滚版本")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl rollout undo deployment hello-deploy --to-revision"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\ndeployment.apps/hello-deploy rolled back\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("再次查看ReplicaSet对象, 旧的ReplicaSet中的Pod对象已经开始逐个启动, 新的ReplicaSet中的Pod对象开始逐个销毁")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("deployments"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get rs\nNAME                      DESIRED   CURRENT   READY   AGE\nhello-deploy-65cbc9474c   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("       20m\nhello-deploy-6f797c4b74   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("       6m59s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h2",{attrs:{id:"service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service"}},[s._v("#")]),s._v(" Service")]),s._v(" "),a("p",[s._v("由于Pod可能会出现扩缩容, 故障时替换的情况, 导致了Pod的IP地址变化. 因此Pod时不可靠的, 我们不能直接去依赖Pod. Service解决了这个问题, 它提供了稳定的网络.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-service.png",alt:"k8s-service"}}),s._v("\n我们可以把Service对象想象为具备前后两端. 前端有自己的DNS名称, IP和端口号; 后端有对Pod的动态负载均衡机制, 并且实现了自我监控, 可以自动更新.\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-servoce-selector.png",alt:"k8s-service"}}),s._v("\nService使用标签和标签选择器来决定将流量负载均衡到哪个Pod.")]),s._v(" "),a("h3",{attrs:{id:"endpoint"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#endpoint"}},[s._v("#")]),s._v(" Endpoint")]),s._v(" "),a("p",[s._v("Service在创建后都会得到一个关联的Endpoint对象, 这个对象是一个动态的列表, 包含了所有匹配Service Selector的健康Pod.")]),s._v(" "),a("p",[s._v("当Service有流量需要转发时, 通过Endpoint对象中的Pod列表来查找Pod")]),s._v(" "),a("p",[s._v("启动会Service后可以查看对应的Endpint对象")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("services"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get ep hello-svc\nNAME        ENDPOINTS                                                  AGE\nhello-svc   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(".0.37:8080,10.1.0.38:8080,10.1.0.39:8080 + "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" more"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   9m21s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"type"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#type"}},[s._v("#")]),s._v(" type")]),s._v(" "),a("p",[s._v("Service有多种类型, 不同类型的Service对应不同的外部访问策略")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("ClusterIP")])])]),s._v(" "),a("p",[s._v("ClusterIP类型的Service有固定的IP和端口号, "),a("strong",[s._v("只能从集群的内部访问")]),s._v(".")]),s._v(" "),a("p",[s._v("ClusterIP与Service名称一起被注册到集群内部的DNS服务中. 因为所有Pod都知道集群的DNS服务, 所以所有的Pod都能够解析Service名称. 之所以是内部访问是因为要访问集群的DNS才能够找到对应的IP,\n所以ClusterIP类型的Service只对Pod和集群中的其他对象奏效.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("NodePort")])])]),s._v(" "),a("p",[s._v("NodePort在ClusterIP的基础上增加了外部访问的能力.")]),s._v(" "),a("p",[s._v("NodePort在集群的人与节点上都是相同的, 也就是从集群外部访问任一节点上的NodePort指定的端口号都可以找到Service, 即使这个节点上并没有Service及其选择器对应的Pod")]),s._v(" "),a("p",[s._v("集群内部的Pod找到Service要通过名称, 而外部的则是通过NodePort.")]),s._v(" "),a("p",[s._v("NodePort的端口范围在30000-32767之间")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("LoadBalancer")])])]),s._v(" "),a("p",[s._v("LoadBalancer同样能够在外部访问, 同时他还能够与云服务上提供的负载均衡服务集成. 他是基于NodePort实现的.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("ExternalName")])])]),s._v(" "),a("p",[s._v("ExternalName能够将流量路由到k8s之外的系统")]),s._v(" "),a("h3",{attrs:{id:"manifest-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest-3"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("p",[s._v("前面的实例中已经通过Deployment部署了10个监听8080端口的Pod. 但是因为没有配置网络, 所以我们通过宿主机IP+8080并不能访问到内部的Pod. 正好可以通过NodePort Service的方式去接收流量.")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("svc\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("world\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30001")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hello"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("world\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("metadata中的labels并不是用来筛选Pod的, 而是用来匹配Service的.")]),s._v(" "),a("p",[s._v("spec中定义信息解释:")]),s._v(" "),a("ul",[a("li",[s._v("type: 表明service类型为NodePort, 可被集群外访问")]),s._v(" "),a("li",[s._v("ports:\n"),a("ul",[a("li",[s._v("port: 指的是Service暴露在ClusterIP上的端口号. 这是提供给集群内部来使用的.")]),s._v(" "),a("li",[s._v("nodePort: 对外监听30001端口, 也就是集群外部通过<集群任意节点IP>:30001就可以访问到这个Service对象")]),s._v(" "),a("li",[s._v("targetPort: 当收到请求后, 将流量路由到Pod的8080端口上")]),s._v(" "),a("li",[s._v("protocol: 使用TCP协议, 这也是默认的")])])]),s._v(" "),a("li",[s._v("selector: 上面ports中配置的流量路由策略会作用到标签含有app=hello-world的pod上")])]),s._v(" "),a("p",[s._v("通过apply提交后访问http://127.0.0.1:30001\n"),a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-servoce-nodeport.png",alt:"k8s-service-nodeport"}})]),s._v(" "),a("p",[s._v("使用logs命令可以查看这次流量被路由到了哪个节点")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("services"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl logs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" service/hello-svc\nFound "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" pods, using pod/hello-deploy-65cbc9474c-77xx9\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"服务注册与服务发现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务注册与服务发现"}},[s._v("#")]),s._v(" 服务注册与服务发现")]),s._v(" "),a("blockquote",[a("p",[s._v("填坑之前"),a("RouterLink",{attrs:{to:"/microservice/contact.html#平台服务发现模式"}},[s._v("微服务专栏")]),s._v("中提到的虚拟IP实现服务发现部分")],1)]),s._v(" "),a("h3",{attrs:{id:"服务注册"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务注册"}},[s._v("#")]),s._v(" 服务注册")]),s._v(" "),a("p",[s._v("k8s内部使用一个DNS服务作为服务注册中心, 他实际上是运行在kube-system命名空间中的一个名为coredns的由Deployment管理的一组Pod. 是k8s的原生应用.")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("services"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" k8s-app"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-dns\nNAME                      READY   STATUS    RESTARTS   AGE\ncoredns-f9fd979d6-9sg5x   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h3m\ncoredns-f9fd979d6-bpkhw   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h3m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ol",[a("li",[s._v("POST Service的manifest文件到API Server")]),s._v(" "),a("li",[s._v("Service被分配ClusterIP")]),s._v(" "),a("li",[s._v("配置持久化到集群存储")]),s._v(" "),a("li",[s._v("Endpoint对象被创建")]),s._v(" "),a("li",[s._v("集群的DNS发现新的Service")])]),s._v(" "),a("blockquote",[a("p",[s._v("DNS内部有一个Controller会监听API Server")])]),s._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[s._v("创建新的DNS记录")]),s._v(" "),a("li",[s._v("每个节点上的kube proxy拉取Service配置")]),s._v(" "),a("li",[s._v("创建IPVS规则")])]),s._v(" "),a("blockquote",[a("p",[s._v("每个节点的kubelet进程都会监视Endpoint对象的创建")])]),s._v(" "),a("h3",{attrs:{id:"服务发现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务发现"}},[s._v("#")]),s._v(" 服务发现")]),s._v(" "),a("p",[s._v("k8s会自动配置所有容器, 让他们能够找到集群的DNS, 并用来将Service名字解析为ClusterIP. 实际操作是k8s为每个容器都注入了一个/etc/resolv.conf.")]),s._v(" "),a("ol",[a("li",[s._v("通过DNS解析到Service对应的ClusterIP")]),s._v(" "),a("li",[s._v("将流量发送到ClusterIP")]),s._v(" "),a("li",[s._v("但是没有路由, 将流量发送到容器的默认网关")])]),s._v(" "),a("blockquote",[a("p",[s._v("因为这个ClusterIP是在一个特殊的名为servicenetwork的网络上, 是没有路由可达的, 所以容器不知道该把流量发到哪, 只能发送到默认网关.")])]),s._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[s._v("转发到集群节点")]),s._v(" "),a("li",[s._v("集群节点也没有路由, 在转发到节点的默认网关")])]),s._v(" "),a("blockquote",[a("p",[s._v("由于主机节点同样没有servicenetwork的路由, 所以只能再发往自身的默认网关.")])]),s._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[s._v("流量被节点内核处理")]),s._v(" "),a("li",[s._v("流量被IPVS规则捕获")]),s._v(" "),a("li",[s._v("将流量发往的目标IP重写为Pod的IP")])]),s._v(" "),a("h3",{attrs:{id:"故障排查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#故障排查"}},[s._v("#")]),s._v(" 故障排查")]),s._v(" "),a("p",[s._v("由于k8s使用集群内置DNS服务作为服务的注册中心使用, 所以如果有服务注册发现相关的问题应该先排查这里.")]),s._v(" "),a("p",[s._v("集群的DNS是一组运行在kube-system命名空间中的pod和一个用来提供稳定网络入库的Service对象构成. 他主要包括三个组件:")]),s._v(" "),a("ul",[a("li",[s._v("pods: 由coredns Deployment管理")]),s._v(" "),a("li",[s._v("Service: 一个名为kube-dns的ClusterIP Service, 监听TCP/UDP 53端口")]),s._v(" "),a("li",[s._v("Endpoint: 也叫kube-dns")])]),s._v(" "),a("p",[s._v("所有与集群DNS相关的对象都有一个k8s-app=kube-dns的标签. 这个需要记住. 方便命令排查.")]),s._v(" "),a("p",[s._v("针对DNS的排查过程如下:")]),s._v(" "),a("ol",[a("li",[s._v("先确定coredns Deployment及其管理的pods运行状态.")]),s._v(" "),a("li",[s._v("查看coredns的每个pod的日志")]),s._v(" "),a("li",[s._v("查看Service是否在运行中, 且监听端口是53, 且有ClusterIP")]),s._v(" "),a("li",[s._v("查看Endpoint对象是否正在运行且拥有所有coredns pod的IP地址")])]),s._v(" "),a("p",[s._v("当DNS排查没有问题后, 可以再通过启动一个单例的名为dnsutils的pod来排查. 这个pod中内置了一些常用的网络工具如ping, curl, nslookup.")]),s._v(" "),a("h2",{attrs:{id:"存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储"}},[s._v("#")]),s._v(" 存储")]),s._v(" "),a("p",[s._v("k8s的存储与docker的存储不一样, 它要复杂的多, pod将资源挂载到外部存储需要很多个步骤, 不过也正因如此, k8s对存储的控制也更灵活多变.")]),s._v(" "),a("p",[s._v("k8s的存储分为三部分: "),a("strong",[s._v("持久化卷子系统, 插件, 存储提供者")]),s._v(".")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/NiceAshin/FileStore/blogImage/k8s-storage.png",alt:"k8s-storage"}})]),s._v(" "),a("p",[s._v("pod对象通过持久化卷子系统来完成数据与外部存储的挂载. 而k8s的持久化卷子系统通过插件层访问存储提供者.")]),s._v(" "),a("p",[s._v("持久化卷中有三个主要的组件: "),a("strong",[s._v("PV: 持久化卷, PVC: 持久化卷的访问许可, CS: 存储类")]),s._v(".")]),s._v(" "),a("h3",{attrs:{id:"volume"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#volume"}},[s._v("#")]),s._v(" Volume")]),s._v(" "),a("p",[s._v("k8s为不同的部署环境, 使用需求提供了支持非常多的卷类型. 主要分为两类: 节点宿主机存储与节点外存储.")]),s._v(" "),a("p",[s._v("节点外存储有"),a("code",[s._v("awsElasticBlockStore(亚马逊ES卷存储)")]),s._v(", "),a("code",[s._v("azureDisk(微软Azure)")]),s._v("等等等等.")]),s._v(" "),a("p",[s._v("节点宿主机存储如"),a("code",[s._v("hostPath")]),s._v(", "),a("code",[s._v("local")]),s._v("则是将节点宿主机的文件系统上的文件或目录挂载到使用这个卷的Pod中.")]),s._v(" "),a("p",[s._v("卷不能挂载到其他卷之上, 也不能与其他卷有硬连接. Pod配置中的每个容器都必须独立指定各个卷的挂在位置.")]),s._v(" "),a("h4",{attrs:{id:"manifest-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest-4"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pd\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("container\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3000"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pd\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("volume\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("volume\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 宿主上目录位置")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("在这个声明Pod的模版中的spec部分一并声明了一个hostPath的卷, 指定挂载到主机的/data目录下")]),s._v(" "),a("h3",{attrs:{id:"persistent-volume"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#persistent-volume"}},[s._v("#")]),s._v(" Persistent Volume")]),s._v(" "),a("p",[s._v("k8s中的PV对象不像docker, 它可以绑定本地磁盘以及其他外部存储, 他定义了集群的存储采用什么介质.")]),s._v(" "),a("p",[s._v("一个外部存储只能被一个PV使用, 一个PV可以被多个POD访问, 但是要定义规则来确保正常访问, 同时Pod不能直接访问PV, 必须经过PVC.PV对象可以通过PVC对Pod实现共享.")]),s._v(" "),a("p",[a("strong",[s._v("PV")]),s._v("有三种访问模式:")]),s._v(" "),a("ul",[a("li",[s._v("ReadWriteOnce: 限制一个PV只能以读写方式绑定到一个PVC上, 如果尝试绑定到多个PVC将会失败.")]),s._v(" "),a("li",[s._v("ReadWriteMany: 允许一个PV以读写方式挂载到多个PVC上, 这种模式只支持NFS这样的文件或对象存储.")]),s._v(" "),a("li",[s._v("ReadOnlyMany: 允许以只读方式挂载到多个PVC上")])]),s._v(" "),a("p",[s._v("PV的核心是一个目录, 其中可能存有数据, Pod中的容器可以访问这个目录中的数据, 所采用的特定的卷类型将决定目录如何形成, 使用何种介质保存数据以及目录中存放的内容.")]),s._v(" "),a("p",[s._v("PV可以事先通过manifest文件提供, 也可以通过SC动态创建. 他的生命周期独立于使用它的Pod.")]),s._v(" "),a("h4",{attrs:{id:"manifest-5"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest-5"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolume\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" manual\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("capacity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10Gi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("这个文件的声明含义是挂载主机的/data目录上, 并且只占用10G存储空间; 除此之外, 对PVC允许的访问模式是ReadWriteOnce. storageClassName指定为manual. 后面的SC部分会将.")]),s._v(" "),a("h3",{attrs:{id:"pvc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pvc"}},[s._v("#")]),s._v(" PVC")]),s._v(" "),a("p",[s._v("Persistent Volume Claim表达的是Pod对PV的使用请求. 概念与Pod相似. Pod会占用节点的资源, 而PVC"),a("strong",[s._v("申领")]),s._v("会占用PV的资源. Pod可以请求特定数量的资源如CPU和内存. PVC申领也可以请求特定的大小和访问模式.")]),s._v(" "),a("p",[s._v("当pod通过PVC访问PV时, 可以选择将PV中的某个目录挂载到pod中的容器目录上.")]),s._v(" "),a("p",[s._v("当不再使用PV时, 我们可以通知API Server将PVC删除, 来回收再利用资源. PVC有三种回收策略来告诉集群, 当PV从申领中释放时应该如何处理这个数据卷.")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Retain")]),s._v(": 保留PV对象以及外部存储中的资源, 但是这回导致其他PVC无法继续使用这个PV. 如果要重复使用这个PV占用的存储, 可以手动删除PV对象. PV对象绑定的外部存储中的数据是会保留的.")]),s._v(" "),a("li",[a("strong",[s._v("Delete")]),s._v(": 删除PVC时, 同时将PV以及PV在外部存储中的资源删除. 这是"),a("strong",[s._v("默认")]),s._v("的.")])]),s._v(" "),a("h4",{attrs:{id:"manifest-6"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest-6"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolumeClaim\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("claim\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" manual\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 3Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("这个文件的含义是PVC申领storageClassName为manual的PV对象大小为3G的存储空间. 这里spec.storageClassName要与PV的manifest中的spec.storageClassName相对应.")]),s._v(" "),a("p",[s._v("accessModes声明为rwo, 将会去寻找相同storageClassName下的支持row访问模式的PV对象.")]),s._v(" "),a("p",[s._v("在执行apply提交后, 控制平面将会查找有相同storageClassName的且满足申领要求的PV对象, 如果找的到, 则绑定到那个PV对象上. 否则将会一直处于Pending状态")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("storage"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl get pvc\nNAME            STATUS   VOLUME    CAPACITY   ACCESS MODES   STORAGECLASS   AGE\ntest-pv-claim   Bound    test-pv   10Gi       RWO            manual         2s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("Pod使用PVC:")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" task"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("persistentVolumeClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("claimName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("claim\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("container\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3000"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/test-vol"')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("spec.volumes中不再使用hostPath. 使用persistentVolumeClaim去指定要使用的PVC.")]),s._v(" "),a("h3",{attrs:{id:"sc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sc"}},[s._v("#")]),s._v(" SC")]),s._v(" "),a("p",[s._v("在大规模集群中, 手动创建大量PV和PVC是非常烦琐的. 这时可以使用StorageClass来动态分配. SC可以让我们不用手动创建PV, 只需要创建一个SC对象, 然后使用一个插件与\n具体的某个存储后端联系起来.")]),s._v(" "),a("p",[s._v("SC创建后会观察API Server上是否有新的被关联的PVC对象, 如果匹配的PVC出现, SC会自动在后端存储系统上创建所需要的卷,以及在k8s上创建PV.")]),s._v(" "),a("p",[s._v("SC还有一个重要的作用是减少PVC对PV的详细信息的依赖.")]),s._v(" "),a("h4",{attrs:{id:"manifest-7"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#manifest-7"}},[s._v("#")]),s._v(" manifest")]),s._v(" "),a("p",[s._v("还是在本地测试一下")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" storage.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StorageClass\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("provisioner")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes.io/no"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("provisioner\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeBindingMode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" WaitForFirstConsumer\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("在定义SC的manifest时注意apiVersion为"),a("code",[s._v("storage.k8s.io/v1")])]),s._v(" "),a("ul",[a("li",[s._v("provisioner: 表示不使用外部存储, 采用本地存储")]),s._v(" "),a("li",[s._v("volumeBindingMode: 表示延迟绑定. PVC与PV的绑定被延迟到Pod的第一次调度时.")])]),s._v(" "),a("p",[s._v("SC对象是不可变得, 在部署之后不可以再修改.")]),s._v(" "),a("p",[s._v("定义一个PVC对象供Pod使用")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolumeClaim\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ticket\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("部署之后查看PVC状态处于Pending, 也就是等待绑定的状态.")]),s._v(" "),a("p",[s._v("再启动一个Pod的使用PVC")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" class"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" data\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("persistentVolumeClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("claimName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ticket\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ubuntu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ctr\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ubuntu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /bin/bash\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep 60m"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("发现启动报错")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("  Type     Reason            Age    From               Message\n  ----     ------            ----   ----               -------\n  Warning  FailedScheduling  10m    default-scheduler  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1 nodes are available: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" didn"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'t find available persistent volumes to bind.\n  Warning  FailedScheduling  10m    default-scheduler  0/1 nodes are available: 1 node(s) didn'")]),s._v("t "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" available persistent volumes to bind.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这是因为本地卷还不支持动态制备. 所以我们要先提供一个PV.")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolume\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storageClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" local"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("storage\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("capacity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2Gi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /tmp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("再次查看Pod状态已经运行成功.")]),s._v(" "),a("blockquote",[a("p",[s._v("更多的StorageClass  https://kubernetes.io/zh/docs/concepts/storage/storage-classes/")])]),s._v(" "),a("h2",{attrs:{id:"configmap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configmap"}},[s._v("#")]),s._v(" ConfigMap")]),s._v(" "),a("p",[s._v("ConfigMap对象将配置数据从Pod中剥离出来. 并可以动态的在Pod运行时注入数据.")]),s._v(" "),a("h3",{attrs:{id:"创建方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建方式"}},[s._v("#")]),s._v(" 创建方式")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("命令式")]),s._v(":")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("storage"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl create configmap profile --from-literal "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("杨同港 --from-literal "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("wx")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ytg2097\nconfigmap/profile created\n\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("声明式")]),s._v(":")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("storage"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl create cm profile-json --from-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("profile.json\nconfigmap/profile-json created\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"姓名"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"杨同港"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"微信号"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ytg2097"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"注入方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注入方式"}},[s._v("#")]),s._v(" 注入方式")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("环境变量")]),s._v(":")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("chapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" configmaps\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" envpod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" OnFailure\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ctr1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"300"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" WX\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMapKeyRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" profile\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" wx\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NAME\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMapKeyRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" profile\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("查看环境变量")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("configmaps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" envpod "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\nkubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("POD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("COMMAND"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" is DEPRECATED and will be removed "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a future version. Use kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("POD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" -- "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("COMMAND"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" instead.\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# echo name:$NAME  wx: $WX")]),s._v("\nname:Ashin wx: Ashin\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("容器启动命令参数")]),s._v(":")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("chapter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" configmaps\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" envpod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" OnFailure\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ctr1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"echo 博客作者: $(NAME) 微信号 $(WX) 济南的爷就是爷, 除了吃就是玩, 没别哒!"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" WX\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMapKeyRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" profile\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" wx\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NAME\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMapKeyRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" profile\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" name\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("configmaps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" envpod.yml\npod/envpod created\n\nF:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("configmaps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl logs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" envpod\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("ul",[a("li",[a("strong",[s._v("某个卷上的文件")]),s._v(":\n这个很好理解. 我们使用卷挂载方式访问数据无非是将应用运行时产生数据保存. 和应用运行时读取两种用途.")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cmvol\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" volmap\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configMap")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" profile\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ctr\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" volmap\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/name\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("F:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("学习"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("TheK8sBook"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("configmaps"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" cmvol "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /etc/name\nkubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("POD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("COMMAND"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" is DEPRECATED and will be removed "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a future version. Use kubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("POD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" -- "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("COMMAND"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" instead.\nname  wx\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"statefulset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#statefulset"}},[s._v("#")]),s._v(" StatefulSet")]),s._v(" "),a("p",[s._v("StatefulSet也是k8s中的一等公民, 与Deployment的具备相同的能力, 可以管理Pod, 进行动态扩缩容, 故障自愈, 滚动升级.")]),s._v(" "),a("h3",{attrs:{id:"不同点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不同点"}},[s._v("#")]),s._v(" 不同点")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("Pod名字可预知且保持不变")]),s._v("\n原因是StatefulSet启动Pod是有顺序的, Pod的命名是<StatefulSet名称>-<1>,<StatefulSet名称>-<2>,<StatefulSet名称>-<n>")]),s._v(" "),a("li",[a("strong",[s._v("DNS主机名可预知保持不变")]),s._v("\nDNS的主机名就是StatefulSet的名称")]),s._v(" "),a("li",[a("strong",[s._v("卷绑定可预知保持不变")])])]),s._v(" "),a("p",[s._v("以上三个特性在哪些要求Pod保持不变的应用中非常有用.")]),s._v(" "),a("h3",{attrs:{id:"headlessservice"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#headlessservice"}},[s._v("#")]),s._v(" headlessService")]),s._v(" "),a("p",[s._v("由StatefulSet部署的Pod是可预知的. 所以我们的一些应用可能会直接连接到某个Pod上去. 为了实现这一功能, k8s提供了一个特殊的Service对象headlessService来为StatefulSet使用headlessService来为StatefulSet中的每个Pod副本创建一个可预知的DNS主机名.")]),s._v(" "),a("p",[s._v("headlessService是一个将spec.clusterIP设置为None的Service对象. 当这个headlessService设置为StatefulSet的"),a("code",[s._v("spec.service.Name")]),s._v("时就成为了StatefulSet的governingService.")]),s._v(" "),a("h3",{attrs:{id:"volumeclaimtemplate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#volumeclaimtemplate"}},[s._v("#")]),s._v(" volumeClaimTemplate")]),s._v(" "),a("p",[s._v("在使用StatefulSet时, 如果没有Pod有独立存储的需求时, 可以使用volumeClaimTemplates.")]),s._v(" "),a("p",[s._v("volumeClaimTemplate在每次创建一个新的Pod副本时, 会自动创建一个PVC, 还会自动为PVC命名, 用来准确关联Pod, PVC名为<volumeClaimTemplate名称>-<Pod名>")]),s._v(" "),a("blockquote",[a("p",[s._v("更多内容见官方文档  https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/")])]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"title"},[s._v("注意")]),a("p",[s._v("在删除StatefulSet之前最好先缩容Pod副本数量到0来保证本地缓存安全落库")])])])}),[],!1,null,null,null);a.default=e.exports}}]);