(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{481:function(s,t,a){"use strict";a.r(t);var n=a(2),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"go-并发模式与调度深入解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#go-并发模式与调度深入解析"}},[s._v("#")]),s._v(" Go 并发模式与调度深入解析")]),s._v(" "),t("blockquote",[t("p",[s._v("预计阅读时间：10 分钟")])]),s._v(" "),t("h2",{attrs:{id:"_1-背景与资料来源"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-背景与资料来源"}},[s._v("#")]),s._v(" 1. 背景与资料来源")]),s._v(" "),t("p",[s._v("文章梳理来自《The Go Programming Language》、Go 官方调度器演讲（GopherCon 2018）、Uber/Mercari 等公司的生产案例，以及我们团队在实时风控系统中对 Goroutine 泄露与调度阻塞的实战复盘。")]),s._v(" "),t("h2",{attrs:{id:"_2-现状-协程友好但风险并存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-现状-协程友好但风险并存"}},[s._v("#")]),s._v(" 2. 现状：协程友好但风险并存")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("调度可视化工具匮乏")]),s._v("：默认 "),t("code",[s._v("pprof")]),s._v(" 难以呈现 Goroutine 的阻塞图谱，常需借助 async-profiler、Goroutine Dump 工具配合分析。")]),s._v(" "),t("li",[t("strong",[s._v("通道滥用")]),s._v("：在业务逻辑中随意堆砌 "),t("code",[s._v("chan")]),s._v(" 导致死锁、内存涨幅不可控。")]),s._v(" "),t("li",[t("strong",[s._v("资源治理缺位")]),s._v("：未限制 Goroutine 数量，令高并发时后台任务暴涨，抢占核心业务线程。")])]),s._v(" "),t("h2",{attrs:{id:"_3-调度模型核心"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-调度模型核心"}},[s._v("#")]),s._v(" 3. 调度模型核心")]),s._v(" "),t("p",[s._v("Go 调度采用 M-P-G 模型：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("M（Machine）")]),s._v(" 映射操作系统线程。")]),s._v(" "),t("li",[t("strong",[s._v("P（Processor）")]),s._v(" 代表逻辑处理器，负责运行队列。")]),s._v(" "),t("li",[t("strong",[s._v("G（Goroutine）")]),s._v(" 为用户态协程。")])]),s._v(" "),t("div",{staticClass:"language-mermaid line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-mermaid"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("graph")]),s._v(" LR\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("subgraph")]),s._v(" Scheduler\n    P1"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("((P1))")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),t("span",{pre:!0,attrs:{class:"token label property"}},[s._v("|Local Runq|")]),s._v(" G1"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("((G1))")]),s._v("\n    P1 "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" G2"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("((G2))")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("end")]),s._v("\n    M1"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("((M1))")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" P1\n    M2"),t("span",{pre:!0,attrs:{class:"token text string"}},[s._v("((M2))")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),s._v(" P1\n    G1 "),t("span",{pre:!0,attrs:{class:"token arrow operator"}},[s._v("--\x3e")]),t("span",{pre:!0,attrs:{class:"token label property"}},[s._v("|Syscall|")]),s._v(" M2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("了解该模型有助于解释以下问题：")]),s._v(" "),t("ul",[t("li",[s._v("为什么 "),t("code",[s._v("runtime.GOMAXPROCS")]),s._v(" 决定并行度。")]),s._v(" "),t("li",[s._v("Goroutine 在系统调用阻塞时如何被调度器“偷走”。")]),s._v(" "),t("li",[s._v("大量短生命周期 Goroutine 时，调度器如何通过 "),t("code",[s._v("work stealing")]),s._v(" 均衡队列。")])]),s._v(" "),t("h2",{attrs:{id:"_4-常见并发模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-常见并发模式"}},[s._v("#")]),s._v(" 4. 常见并发模式")]),s._v(" "),t("h3",{attrs:{id:"_4-1-worker-pool"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-worker-pool"}},[s._v("#")]),s._v(" 4.1 Worker Pool")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("worker")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tasks "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sync"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" wg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ok "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("tasks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("ok "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("process")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[t("strong",[s._v("实战建议")]),s._v("：")]),s._v(" "),t("ul",[t("li",[s._v("限制 "),t("code",[s._v("tasks")]),s._v(" 缓冲区大小，防止消费者堆积。")]),s._v(" "),t("li",[s._v("借助 "),t("code",[s._v("errgroup")]),s._v(" 统一控制生命周期。")])]),s._v(" "),t("h3",{attrs:{id:"_4-2-pipeline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-pipeline"}},[s._v("#")]),s._v(" 4.2 Pipeline")]),s._v(" "),t("p",[s._v("将复杂任务拆为多级管道，每级聚焦单一职责：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" Result "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    Item  Item\n    Err   "),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("error")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stageDecode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("in "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("byte")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Result "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    out "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" raw "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" in "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            item"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("decode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("raw"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            out "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v(" Result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("Item"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" item"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" Err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" err"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" out\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("通过 pipeline 结合 backpressure，可在日志消费、实时指标归档等场景中保持流量平稳。")]),s._v(" "),t("h3",{attrs:{id:"_4-3-扇入-扇出-fan-in-fan-out"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-扇入-扇出-fan-in-fan-out"}},[s._v("#")]),s._v(" 4.3 扇入/扇出（Fan-in/Fan-out）")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("select")]),s._v(" 汇聚多个信道：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("merge")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ctx context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("...")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Event "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    out "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" wg sync"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("WaitGroup\n    output "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" Event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" wg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" evt "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" c "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("ctx"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Done")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" out "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v(" evt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    wg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("len")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("range")]),s._v(" cs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("output")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        wg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Wait")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("close")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" out\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("h2",{attrs:{id:"_5-调度治理手册"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-调度治理手册"}},[s._v("#")]),s._v(" 5. 调度治理手册")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("设定 Goroutine 上限")]),s._v("：利用 "),t("code",[s._v("semaphore")]),s._v(" 控制后台任务并发度，防止流量洪峰拖垮核心服务。")]),s._v(" "),t("li",[t("strong",[s._v("Trace + Metrics")]),s._v("：在业务关键路径埋点 "),t("code",[s._v("runtime/trace")]),s._v(" 与 "),t("code",[s._v("expvar")]),s._v(" 指标，结合 Prometheus 监控 Goroutine 数量、GC 停顿时间。")]),s._v(" "),t("li",[t("strong",[s._v("Goroutine 泄露检测")]),s._v("：集成 "),t("code",[s._v("uber-go/goleak")]),s._v(" 到单元测试，防止测试结束时仍有 Goroutine 存活。")]),s._v(" "),t("li",[t("strong",[s._v("热点隔离")]),s._v("：对于 CPU 密集型任务，考虑 "),t("code",[s._v("worker")]),s._v(" 绑定至独立 "),t("code",[s._v("P")]),s._v(" 或使用 "),t("code",[s._v("runtime.LockOSThread")]),s._v("，与 IO 协程隔离。")])]),s._v(" "),t("h2",{attrs:{id:"_6-与业务场景结合"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-与业务场景结合"}},[s._v("#")]),s._v(" 6. 与业务场景结合")]),s._v(" "),t("p",[s._v("在实时风控中，我们通过以下方式优化：")]),s._v(" "),t("ul",[t("li",[s._v("将原先所有请求共享的 "),t("code",[s._v("chan")]),s._v(" 改为分区队列，根据用户 ID 哈希分桶，减少锁竞争。")]),s._v(" "),t("li",[s._v("将风险决策服务拆分为“特征收集”、“模型推断”、“结果写回”三段 pipeline，结合 Kafka backpressure 保证稳定性。")]),s._v(" "),t("li",[s._v("使用 Grafana 展示 Goroutine 上下限、平均等待时长与拒绝率，让业务团队可以感知到风控服务的容量边界。")])]),s._v(" "),t("h2",{attrs:{id:"_7-进一步阅读"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-进一步阅读"}},[s._v("#")]),s._v(" 7. 进一步阅读")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://go.dev/blog/trace",target:"_blank",rel:"noopener noreferrer"}},[s._v("Go Scheduler Tracing"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://eng.uber.com/go-channels/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Uber Engineering: Channel Primitives"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("[GopherCon 2023: Practical Go Concurrency Patterns]")])]),s._v(" "),t("p",[s._v("掌握调度原理与模式库，才能在复杂业务高峰期保障 Go 服务的稳定性与弹性扩展能力。")])])}),[],!1,null,null,null);t.default=r.exports}}]);